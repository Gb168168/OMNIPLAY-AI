<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>員工假管理系統-84</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html,
        body,
        #root {
            margin: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #ffffff;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Lucide Icons 組件
        const Users = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        const Calendar = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const FileText = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
        );

        const Clock = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        );

        const Clipboard = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
            </svg>
        );

        const LogOut = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
        );

        const Download = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const Trash2 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        );

        const Edit2 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
            </svg>
        );

        const Bell = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
        );

        const defaultManagementCategories = ['新竹區', '台中區', '嘉義區'];
        const regionOptions = [...defaultManagementCategories];
        const departmentOptions = ['管理部', 'TSE', 'FAE', '新場', '倉管', 'RD', '線上客服']
        const COMPANY_EMAIL_DOMAIN = '@goldbricks.com.tw';
        const HEADER_HEIGHT = '7rem';

        const toEmailLocalPart = (email = '') => {
            if (!email) return '';
            const normalizedEmail = email.trim().toLowerCase();
            if (normalizedEmail.endsWith(COMPANY_EMAIL_DOMAIN)) {
                return normalizedEmail.slice(0, -COMPANY_EMAIL_DOMAIN.length);
            }
            const [localPart = ''] = normalizedEmail.split('@');
            return localPart;
        };

        const buildCompanyEmail = (localPart = '') => {
            const normalizedLocal = localPart.trim().toLowerCase();
            return normalizedLocal ? `${normalizedLocal}${COMPANY_EMAIL_DOMAIN}` : '';
        };
        
        const createNewUserForm = (regionList = regionOptions, defaultRegion = regionList[0] || regionOptions[0]) => ({
            id: '',
            username: '',
            name: '',
            region: defaultRegion,
            department: departmentOptions[0],
            position: '專員',
            email: '',
            phone: '',
            birthday: '',
            shift: [],
            annualLeave: 10,
            autoWeekendHoliday: false,
            isAdmin: false,
            permissionRegions: [...regionList],
            permissionDepartments: [...departmentOptions]
        });
        
        const firebaseConfig = {
            apiKey: 'AIzaSyDlckNcNvIBOOEO23gHlt7A-H13mUelYqM',
            authDomain: 'goldbricks-38d0a.firebaseapp.com',
            projectId: 'goldbricks-38d0a',
            storageBucket: 'goldbricks-38d0a.firebasestorage.app',
            messagingSenderId: '14002577439',
            appId: '1:14002577439:web:be07d91cab555954afb52a',
            measurementId: 'G-YY69T47198'
        };

        const firebaseApp = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
        const db = firebaseApp.firestore();
        const sharedStateDoc = db.collection('sharedState').doc('main');

        // 初始化資料
        const initialData = {
            users: [
                {
                    id: 'E001',
                    username: '001',
                    name: '管理員',
                    region: '新竹區',
                    department: '管理部',
                    position: '經理',
                    email: 'admin@company.com',
                    phone: '0912-345-678',
                    birthday: '1980-01-01',
                    shift: ['早'],
                    autoWeekendHoliday: false,
                    isAdmin: true,
                    permissionRegions: [...regionOptions],
                    permissionDepartments: [...departmentOptions],
                    annualLeave: 14,
                    usedAnnualLeave: 0
                },
                {
                    id: 'E002',
                    username: '002',
                    name: '王小明',
                    region: '台中區',
                    department: 'TSE',
                    position: '專員',
                    email: 'wang@company.com',
                    phone: '0923-456-789',
                    birthday: '1990-05-15',
                    shift: ['早', '晚'],
                    autoWeekendHoliday: false,
                    isAdmin: false,
                    permissionRegions: [],
                    permissionDepartments: [],
                    annualLeave: 10,
                    usedAnnualLeave: 2
                }
            ],
            leaves: [],
            schedules: [],
            auditLogs: [],
            managementCategories: [...defaultManagementCategories],
            vacationSettings: {
                openStart: '',
                openEnd: '',
                monthlyVacationDays: ''
            },
            vacationSchedule: {},
            vacationNotes: {}
        };

        // 國定假日資料
        const holidays2026 = [
            { date: '2026-01-01', name: '元旦' },
            { date: '2026-02-15', name: '小年夜' },
            { date: '2026-02-16', name: '除夕' },
            { date: '2026-02-17', name: '初一' },
            { date: '2026-02-18', name: '初二' },
            { date: '2026-02-19', name: '初三' },
            { date: '2026-02-28', name: '和平紀念' },
            { date: '2026-04-04', name: '兒童 節' },
            { date: '2026-04-05', name: '清明 節' },
            { date: '2026-05-01', name: '勞動 節' },
            { date: '2026-06-25', name: '端午 節' },
            { date: '2026-09-28', name: '教師 節' },
            { date: '2026-10-01', name: '中秋 節' },
            { date: '2026-10-10', name: '國慶 日' },
            { date: '2026-10-25', name: '光復 節' },
            { date: '2026-12-25', name: '行憲紀念' }
        ];

        const CURRENT_USER_STORAGE_KEY = 'leaveSystemCurrentUserId';
        const UI_MODE_STORAGE_KEY = 'leaveSystemUiMode';
        const DATA_STORAGE_KEY = 'leaveSystemData';
        const VACATION_TAB_OFFSET_Y = '-22px';
        const SUPER_USER_PASSWORD = '000';
        const SUPER_USER = {
            id: 'E000',
            username: 'GoldBricks',
            password: SUPER_USER_PASSWORD,
            name: 'GoldBricks',
            region: '總部',
            department: '系統管理',
            position: '最高管理者',
            email: 'goldbricks@company.com',
            phone: '0900-000-000',
            birthday: '1980-01-01',
            shift: ['早'],
            autoWeekendHoliday: false,
            annualLeave: 365,
            isAdmin: true,
            permissionRegions: [...regionOptions],
            permissionDepartments: [...departmentOptions]
        };

        const ensureSuperUserExists = (users = []) => {
            const hasSuperUser = users.some(user => user.id === SUPER_USER.id || user.username === SUPER_USER.username);
            if (!hasSuperUser) {
                return [SUPER_USER, ...users];
            }

            return users.map(user => (user.id === SUPER_USER.id || user.username === SUPER_USER.username
                ? { ...user, ...SUPER_USER, isAdmin: true, permissionRegions: [...regionOptions], permissionDepartments: [...departmentOptions] }
                : user
            ));
        };

         const normalizeUserPermissions = (users = []) =>
            users.map(user => {
                if (!user?.isAdmin) {
                    return {
                        ...user,
                        autoWeekendHoliday: Boolean(user?.autoWeekendHoliday),
                        permissionRegions: Array.isArray(user?.permissionRegions) ? user.permissionRegions : [],
                        permissionDepartments: Array.isArray(user?.permissionDepartments) ? user.permissionDepartments : []
                    };
                }

                const savedRegions = Array.isArray(user.permissionRegions) ? user.permissionRegions : [];
                const savedDepartments = Array.isArray(user.permissionDepartments) ? user.permissionDepartments : [];
                const hasExplicitPermissions = savedRegions.length > 0 || savedDepartments.length > 0;

                return {
                    ...user,
                    autoWeekendHoliday: Boolean(user?.autoWeekendHoliday),
                    permissionRegions: hasExplicitPermissions ? savedRegions : [...regionOptions],
                    permissionDepartments: hasExplicitPermissions ? savedDepartments : [...departmentOptions]
                };
            });

        const readCookieValue = (key) => {
            const escapedKey = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const matched = document.cookie.match(new RegExp(`(?:^|; )${escapedKey}=([^;]*)`));
            return matched ? decodeURIComponent(matched[1]) : null;
        };

        const storageGet = (key) => {
            try {
                const value = localStorage.getItem(key);
                if (value !== null) return value;
            } catch (error) {
                // fallback to cookie when localStorage is blocked on mobile webviews
            }
            return readCookieValue(key);
        };

        const storageSet = (key, value) => {
            try {
                localStorage.setItem(key, value);
            } catch (error) {
                // ignore and fallback to cookie below
            }
            document.cookie = `${key}=${encodeURIComponent(value)}; path=/; max-age=31536000; SameSite=Lax`;
        };

        const storageRemove = (key) => {
            try {
                localStorage.removeItem(key);
            } catch (error) {
                // ignore and fallback to cookie below
            }
            document.cookie = `${key}=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax`;
        };

        const mergeWithInitialData = (parsed = {}) => ({
            ...initialData,
            ...parsed,
            users: normalizeUserPermissions(ensureSuperUserExists(parsed.users || initialData.users)),
            managementCategories: Array.from(new Set([...(parsed.managementCategories || []), ...defaultManagementCategories])),
            vacationSettings: {
                ...initialData.vacationSettings,
                ...parsed.vacationSettings
            },
            schedules: parsed.schedules || [],
            vacationSchedule: parsed.vacationSchedule || {},
            vacationNotes: parsed.vacationNotes || {}
        });

        const parseSavedData = (saved) => {
            if (!saved) return null;

            try {
                return JSON.parse(saved);
            } catch (error) {
                return null;
            }
        };
        
        const EmployeeLeaveSystem = () => {
             const [currentUser, setCurrentUser] = useState(() => {
                const savedData = storageGet(DATA_STORAGE_KEY);
                const savedUserId = storageGet(CURRENT_USER_STORAGE_KEY);

                if (!savedData || !savedUserId) return initialData.users[0] || null;

                try {
                    const parsed = JSON.parse(savedData);
                    const users = ensureSuperUserExists(parsed.users || initialData.users);
                    return users.find(user => user.id === savedUserId) || users[0] || initialData.users[0] || null;
                } catch (error) {
                    return initialData.users[0] || null;
                }
            });
            const [activeTab, setActiveTab] = useState('vacation');
            const [uiMode, setUiMode] = useState(() => {
                const savedMode = storageGet(UI_MODE_STORAGE_KEY);
                return savedMode === 'mobile' ? 'mobile' : 'desktop';
            });
            const [data, setData] = useState(() => {
                const saved = storageGet(DATA_STORAGE_KEY);
                     const parsed = parseSavedData(saved);

                     if (!parsed) return {
                        ...initialData,
                        users: normalizeUserPermissions(ensureSuperUserExists(initialData.users))
                    };
                
                return mergeWithInitialData(parsed);
            });
            const [isCloudReady, setIsCloudReady] = useState(false);
            const cloudSaveTimerRef = useRef(null);

            const [selectedMonth, setSelectedMonth] = useState(new Date(2026, 1)); // 2月
            const [workingViewDate, setWorkingViewDate] = useState(new Date());
            const [filterRegion, setFilterRegion] = useState('全部');
            const [filterDepartment, setFilterDepartment] = useState('全部');
            const [filterShift, setFilterShift] = useState('全部');
            const [pendingVacationUserFilter, setPendingVacationUserFilter] = useState([]);
            const [appliedVacationUserFilter, setAppliedVacationUserFilter] = useState([]);
            const [selectedAnnualUserId, setSelectedAnnualUserId] = useState('');
            const [selectedVacationMarker, setSelectedVacationMarker] = useState('▲-black');
            const [showVacationSettings, setShowVacationSettings] = useState(false);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [selectedLoginUserId, setSelectedLoginUserId] = useState('');
            const [isSessionStarted, setIsSessionStarted] = useState(false);
            const [newLeaveForm, setNewLeaveForm] = useState({
                type: '特休',
                startDate: '',
                endDate: '',
                reason: '',
                hours: 8
            });
            const [showScheduleModal, setShowScheduleModal] = useState(false);
            const [selectedScheduleDate, setSelectedScheduleDate] = useState('');
            const [expandedScheduleDate, setExpandedScheduleDate] = useState('');
            const [scheduleForm, setScheduleForm] = useState({ title: '', content: '' });
            const [editingScheduleId, setEditingScheduleId] = useState(null);

            const [showAddUser, setShowAddUser] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [selectedManagementCategory, setSelectedManagementCategory] = useState(defaultManagementCategories[0]);
            const [expandedCategories, setExpandedCategories] = useState({});
            const [expandedDepartments, setExpandedDepartments] = useState({});
            const [newCategoryName, setNewCategoryName] = useState('');
            const [managementCategories, setManagementCategories] = useState(defaultManagementCategories);
            const [newUserForm, setNewUserForm] = useState(() => createNewUserForm(defaultManagementCategories));
            
            useEffect(() => {
                storageSet(DATA_STORAGE_KEY, JSON.stringify(data));
            }, [data]);

            useEffect(() => {
                let isMounted = true;

                const hydrateFromCloud = async () => {
                    try {
                        const snapshot = await sharedStateDoc.get();
                        const cloudPayload = snapshot.data();

                        if (!isMounted || !cloudPayload?.data) return;

                        setData(mergeWithInitialData(cloudPayload.data));

                        if (cloudPayload.currentUserId) {
                            storageSet(CURRENT_USER_STORAGE_KEY, cloudPayload.currentUserId);
                        }
                    } catch (error) {
                        console.warn('Cloud sync unavailable, fallback to local storage only.', error);
                    } finally {
                        if (isMounted) {
                            setIsCloudReady(true);
                        }
                    }
                };

                hydrateFromCloud();

                return () => {
                    isMounted = false;
                };
            }, []);
            
            useEffect(() => {
                if (currentUser?.id) {
                    storageSet(CURRENT_USER_STORAGE_KEY, currentUser.id);
                } else {
                    storageRemove(CURRENT_USER_STORAGE_KEY);
                }
            }, [currentUser]);

             useEffect(() => {
                storageSet(UI_MODE_STORAGE_KEY, uiMode);
            }, [uiMode]);

            useEffect(() => {
                if (!isCloudReady) return;

                if (cloudSaveTimerRef.current) {
                    clearTimeout(cloudSaveTimerRef.current);
                }

                cloudSaveTimerRef.current = setTimeout(() => {
                    sharedStateDoc.set({
                        data,
                        currentUserId: currentUser?.id || null,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true }).catch((error) => {
                        console.warn('Cloud save failed, local data is still available.', error);
                    });
                }, 600);

                return () => {
                    if (cloudSaveTimerRef.current) {
                        clearTimeout(cloudSaveTimerRef.current);
                    }
                };
            }, [data, currentUser, isCloudReady]);

            useEffect(() => {
                document.body.style.overflow = 'hidden';
                document.documentElement.style.overflow = 'hidden';

                return () => {
                    document.body.style.overflow = '';
                    document.documentElement.style.overflow = '';
                };
            }, []);

           useEffect(() => {
                setData(prev => {
                    const normalizedUsers = normalizeUserPermissions(ensureSuperUserExists(prev.users || []));
                    const changed = JSON.stringify(normalizedUsers) !== JSON.stringify(prev.users || []);
                    if (!changed) return prev;
                    return {
                        ...prev,
                        users: normalizedUsers
                    };
                });
            }, []);
            useEffect(() => {
                  if (!currentUser?.id) {
                    const defaultUser = data.users[0] || null;
                    if (defaultUser) {
                        setCurrentUser(defaultUser);
                    }
                    return;
                }

                const latestUser = data.users.find(user => user.id === currentUser.id);
                if (!latestUser) {
                    setCurrentUser(data.users[0] || null);
                    setActiveTab('vacation');
                    return;
                }

                if (JSON.stringify(latestUser) !== JSON.stringify(currentUser)) {
                    setCurrentUser(latestUser);
                }
            }, [data.users, currentUser]);

             useEffect(() => {
                const categorySet = new Set([
                    ...defaultManagementCategories,
                    ...(data.managementCategories || []),
                    ...data.users.map(user => user.region).filter(Boolean)
                ]);
                setManagementCategories(prev => Array.from(new Set([...(prev || []), ...categorySet])));
            }, [data.managementCategories, data.users]);

            useEffect(() => {
                setExpandedCategories(prev => {
                    const next = { ...prev };
                    managementCategories.forEach(category => {
                        if (typeof next[category] === 'undefined') {
                            next[category] = false;
                        }
                    });
                    return next;
                });
            }, [managementCategories]);

             useEffect(() => {
                if (!data.users.length) return;
                setSelectedLoginUserId(prev => {
                    if (prev && data.users.some(user => user.id === prev)) return prev;
                    if (currentUser?.id && data.users.some(user => user.id === currentUser.id)) return currentUser.id;
                    return data.users[0].id;
                });
            }, [data.users, currentUser]);

            const managementRegionOptions = Array.from(new Set([
                ...managementCategories,
                ...data.users.map(user => user.region).filter(Boolean)
            ]));

            const handleSuperUserLogin = () => {
                const password = window.prompt('請輸入最高管理者密碼');
                if (password === null) return;

                if (password !== SUPER_USER_PASSWORD) {
                    alert('密碼錯誤，無法切換為 GoldBricks。');
                    return;
                }

                const superUser = data.users.find(user => user.id === SUPER_USER.id) || SUPER_USER;
                setCurrentUser({ ...superUser, isAdmin: true, permissionRegions: [...regionOptions], permissionDepartments: [...departmentOptions] });
                setActiveTab('management');
                alert('已切換為最高使用者 GoldBricks，可審核與設置所有人的假。');
            };

            const handlePromoteCurrentUser = () => {
                if (!currentUser?.id || currentUser.isAdmin) return;

                setData(prev => ({
                    ...prev,
                    users: prev.users.map(user => {
                        if (user.id !== currentUser.id) return user;
                        return {
                            ...user,
                            isAdmin: true,
                            permissionRegions: [...regionOptions],
                            permissionDepartments: [...departmentOptions]
                        };
                    }),
                    auditLogs: [...prev.auditLogs, {
                        timestamp: new Date().toISOString(),
                        user: currentUser.name,
                        action: '升級權限',
                        details: '將目前登入者設為最高權限，可進行設定與審核'
                    }]
                }));

                alert('已將目前登入帳號升級為最高權限，可進行設定與審核。');
            };

            const handleDeleteUser = (userId) => {
                const user = data.users.find(u => u.id === userId);
                if (!user || !canManageUser(user)) {
                    alert('無權限刪除此員工');
                    return;
                }
                if (window.confirm('確定要刪除此員工嗎?')) {
                    setData(prev => ({
                        ...prev,
                        users: prev.users.filter(u => u.id !== userId),
                        auditLogs: [...prev.auditLogs, {
                            timestamp: new Date().toISOString(),
                            user: currentUser.name,
                            action: '刪除員工',
                            details: user.name
                        }]
                    }));
                }
            };

            const handleToggleCategory = (category) => {
                setExpandedCategories(prev => ({
                    ...prev,
                    [category]: !prev[category]
                }));
            };

             const handleToggleDepartment = (category, department) => {
                const key = `${category}__${department}`;
                setExpandedDepartments(prev => ({
                    ...prev,
                    [key]: !prev[key]
                }));
            };

            const handleAddManagementCategory = () => {
                const category = (newCategoryName || '').trim();
                if (!category) return;
                if (managementRegionOptions.includes(category)) {
                    alert('此收合類別已存在');
                    return;
                }

                setManagementCategories(prev => [...prev, category]);
                setExpandedCategories(prev => ({ ...prev, [category]: false }));
                setData(prev => ({
                    ...prev,
                    managementCategories: [...(prev.managementCategories || []), category],
                    auditLogs: [...prev.auditLogs, {
                        timestamp: new Date().toISOString(),
                        user: currentUser.name,
                        action: '新增收合類別',
                        details: category
                    }]
                }));
                setNewCategoryName('');
            };

            const openAddUserByCategory = (category) => {
                setEditingUser(null);
                setSelectedManagementCategory(category);
                setNewUserForm(createNewUserForm(managementRegionOptions, category));
                setShowAddUser(true);
            };

            const handleEditUser = (user) => {
                if (!canManageUser(user)) {
                    alert('無權限編輯此員工資料');
                    return;
                }
                setEditingUser(user);
                setSelectedManagementCategory(user.region);
                setNewUserForm({
                    id: user.id,
                    username: user.username,
                    name: user.name,
                    region: user.region,
                    department: user.department,
                    position: user.position,
                    email: toEmailLocalPart(user.email),
                    phone: user.phone,
                    birthday: user.birthday,
                    shift: user.shift,
                    annualLeave: user.annualLeave,
                    autoWeekendHoliday: Boolean(user.autoWeekendHoliday),
                    isAdmin: user.isAdmin || false,
                    permissionRegions: Array.isArray(user.permissionRegions) ? user.permissionRegions : [...managementRegionOptions],
                    permissionDepartments: Array.isArray(user.permissionDepartments) ? user.permissionDepartments : [...departmentOptions]
                });
                setShowAddUser(true);
            };

            const handleAddUser = async (e) => {
                e.preventDefault();

                const normalizedId = (newUserForm.id || '').trim();
                const normalizedUsername = (newUserForm.username || '').trim();

                if (!normalizedId) {
                    alert('員工代號為必填!');
                    return;
                }

                const userPayload = {
                    ...newUserForm,
                    id: normalizedId,
                    username: normalizedUsername,
                    email: buildCompanyEmail(newUserForm.email)
                };
                
                if (editingUser) {
                    const targetId = editingUser.id;
                    const nextId = userPayload.id;

                    if (nextId !== targetId && data.users.some(u => u.id === nextId)) {
                        alert('員工代號已存在,請使用其他代號!');
                        return;
                    }

                    if (userPayload.username && data.users.some(u => u.id !== targetId && u.username === userPayload.username)) {
                        alert('帳號已存在,請使用其他帳號!');
                        return;
                    }

                    if (userPayload.email && data.users.some(u => u.id !== targetId && u.email === userPayload.email)) {
                        alert('Email 已存在,請使用其他 Email!');
                        return;
                    }

                    setData(prev => {
                        const updatedUsers = prev.users.map(u =>
                            u.id === targetId
                                ? { ...userPayload, usedAnnualLeave: u.usedAnnualLeave }
                                : u
                         );

                        if (targetId === nextId) {
                            return {
                                ...prev,
                                users: updatedUsers,
                                auditLogs: [...prev.auditLogs, {
                                    timestamp: new Date().toISOString(),
                                    user: currentUser.name,
                                    action: '編輯員工',
                                    details: `${userPayload.id} - ${userPayload.name}`
                                }]
                            };
                        }

                        const updatedLeaves = prev.leaves.map(leave =>
                            leave.userId === targetId
                                ? { ...leave, userId: nextId, userName: userPayload.name, department: userPayload.department, region: userPayload.region }
                                : leave
                        );

                        const nextVacationSchedule = { ...prev.vacationSchedule };
                        if (nextVacationSchedule[targetId]) {
                            nextVacationSchedule[nextId] = nextVacationSchedule[targetId];
                            delete nextVacationSchedule[targetId];
                        }

                        const nextVacationNotes = { ...prev.vacationNotes };
                        if (nextVacationNotes[targetId]) {
                            nextVacationNotes[nextId] = nextVacationNotes[targetId];
                            delete nextVacationNotes[targetId];
                        }

                        return {
                            ...prev,
                            users: updatedUsers,
                            leaves: updatedLeaves,
                            vacationSchedule: nextVacationSchedule,
                            vacationNotes: nextVacationNotes,
                            auditLogs: [...prev.auditLogs, {
                                timestamp: new Date().toISOString(),
                                user: currentUser.name,
                                action: '編輯員工',
                                details: `${targetId} → ${nextId} - ${userPayload.name}`
                            }]
                        };
                    });

                    if (currentUser.id === targetId) {
                        setCurrentUser(prev => prev ? { ...prev, ...userPayload, id: nextId } : prev);
                    }
                    
                    alert('員工資料更新成功!');
                } else {
                    // 新增模式
                    // 檢查員工代號是否已存在
                    if (data.users.find(u => u.id === userPayload.id)) {
                        alert('員工代號已存在,請使用其他代號!');
                        return;
                    }

                    // 檢查帳號是否已存在
                    if (userPayload.username && data.users.find(u => u.username === userPayload.username)) {
                        alert('帳號已存在,請使用其他帳號!');
                        return;
                    }

                    if (userPayload.email && data.users.find(u => u.email === userPayload.email)) {
                        alert('Email 已存在,請使用其他 Email!');
                        return;
                    }

                    const newUser = {
                        ...userPayload,
                        usedAnnualLeave: 0
                    };

                    setData(prev => ({
                         ...prev,
                         users: [...prev.users, newUser],
                        auditLogs: [...prev.auditLogs, {
                            timestamp: new Date().toISOString(),
                            user: currentUser.name,
                            action: '新增員工',
                            details: `${newUser.id} - ${newUser.name}`
                        }]
                    }));
                    alert('員工新增成功!');
                }

                setNewUserForm({
                    id: '',
                    username: '',
                    name: '',
                    region: selectedManagementCategory || managementRegionOptions[0],
                    department: departmentOptions[0],
                    position: '專員',
                    email: '',
                    phone: '',
                    birthday: '',
                    shift: [],
                    annualLeave: 10,
                    autoWeekendHoliday: false,
                    isAdmin: false,
                    permissionRegions: [...managementRegionOptions],
                    permissionDepartments: [...departmentOptions]
                });

                setShowAddUser(false);
                setEditingUser(null);
            };

            const toggleShift = (shiftType) => {
                setNewUserForm(prev => ({
                    ...prev,
                    shift: prev.shift.includes(shiftType)
                        ? prev.shift.filter(s => s !== shiftType)
                        : [...prev.shift, shiftType]
                }));
            };

            const togglePermission = (type, value) => {
                setNewUserForm(prev => {
                    const key = type === 'region' ? 'permissionRegions' : 'permissionDepartments';
                    const current = prev[key] || [];
                    const next = current.includes(value)
                        ? current.filter(item => item !== value)
                        : [...current, value];
                    return { ...prev, [key]: next };
                });
            };

            const getEffectivePermissions = (permissions) =>
                Array.isArray(permissions) ? permissions : [];

            const canManageUser = (targetUser) => {
                if (!currentUser?.isAdmin) return false;
                const regionPermissions = getEffectivePermissions(currentUser.permissionRegions);
                const departmentPermissions = getEffectivePermissions(currentUser.permissionDepartments);
                return regionPermissions.includes(targetUser.region) || departmentPermissions.includes(targetUser.department);
            };

            const canApproveLeave = (leave) => {
                if (!currentUser?.isAdmin) return false;
                const regionPermissions = getEffectivePermissions(currentUser.permissionRegions);
                const departmentPermissions = getEffectivePermissions(currentUser.permissionDepartments);
                return regionPermissions.includes(leave.region) || departmentPermissions.includes(leave.department);
            };

            const pendingLeaves = data.leaves.filter(l => l.status === '待審核');
            const approvablePendingLeaves = pendingLeaves.filter(leave => canApproveLeave(leave));

             const formatLocalDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const parseDateString = (dateStr) => {
                if (!dateStr) return null;
                const [year, month, day] = dateStr.split('-').map(Number);
                if (!year || !month || !day) return null;
                return new Date(year, month - 1, day);
            };
            
            const getCompStats = (userId, monthDate) => {
                const targetMonth = monthDate.getMonth();
                const targetYear = monthDate.getFullYear();
                const compHours = data.leaves.filter(l =>
                    l.userId === userId &&
                    l.type === '補休(時)' &&
                    l.status === '已核准' &&
                    parseDateString(l.startDate)?.getMonth() === targetMonth &&
                    parseDateString(l.startDate)?.getFullYear() === targetYear
                );
                const compDays = data.leaves.filter(l =>
                    l.userId === userId &&
                    l.type === '補休(天)' &&
                    l.status === '已核准' &&
                    parseDateString(l.startDate)?.getMonth() === targetMonth &&
                    parseDateString(l.startDate)?.getFullYear() === targetYear
                );

                return {
                    hours: compHours.reduce((sum, l) => sum + (l.hours || 0), 0),
                    days: compDays.length
                };
            };

            const openScheduleModal = (dateStr) => {
                setSelectedScheduleDate(dateStr);
                setScheduleForm({ title: '', content: '' });
                setEditingScheduleId(null);
                setShowScheduleModal(true);
            };

             const toggleScheduleDateExpand = (dateStr) => {
                setExpandedScheduleDate(prev => (prev === dateStr ? '' : dateStr));
            };

            const handleEditSchedule = (schedule) => {
                setSelectedScheduleDate(schedule.date);
                setScheduleForm({ title: schedule.title, content: schedule.content });
                setEditingScheduleId(schedule.id);
                setShowScheduleModal(true);
            };
            
            const handleScheduleSubmit = (e) => {
                e.preventDefault();
                if (!scheduleForm.title.trim() || !scheduleForm.content.trim()) {
                    alert('請填寫排程標題與內容');
                    return;
                }

                setData(prev => {
                    if (editingScheduleId) {
                        return {
                            ...prev,
                            schedules: (prev.schedules || []).map(schedule =>
                                schedule.id === editingScheduleId
                                    ? {
                                        ...schedule,
                                        title: scheduleForm.title.trim(),
                                        content: scheduleForm.content.trim()
                                    }
                                    : schedule
                            )
                        };
                    }

                    return {
                        ...prev,
                        schedules: [
                            ...(prev.schedules || []),
                            {
                                id: Date.now().toString(),
                                date: selectedScheduleDate,
                                title: scheduleForm.title.trim(),
                                content: scheduleForm.content.trim()
                            }
                        ]
                    };
                });

                setShowScheduleModal(false);
                setEditingScheduleId(null);
            };

            const handleDeleteSchedule = (scheduleId) => {
                if (!window.confirm('確定要刪除此行程嗎？')) return;

                setData(prev => ({
                    ...prev,
                    schedules: (prev.schedules || []).filter(schedule => schedule.id !== scheduleId)
                }));
            };

            const handleSubmitLeave = (e) => {
                e.preventDefault();
                const newLeave = {
                    id: Date.now().toString(),
                    userId: currentUser.id,
                    userName: currentUser.name,
                    department: currentUser.department,
                    region: currentUser.region,
                    ...newLeaveForm,
                    status: '待審核',
                    submittedAt: new Date().toISOString()
                };

                setData(prev => ({
                    ...prev,
                    leaves: [...prev.leaves, newLeave]
                }));

                setNewLeaveForm({
                    type: '特休',
                    startDate: '',
                    endDate: '',
                    reason: '',
                    hours: 8
                });

                alert('請假申請已送出');
            };

            const handleApproveLeave = (leaveId, status) => {
                const targetLeave = data.leaves.find(l => l.id === leaveId);
                if (!targetLeave || !canApproveLeave(targetLeave)) {
                    alert('無權限審核此請假申請');
                    return;
                }
                setData(prev => ({
                    ...prev,
                    leaves: prev.leaves.map(l =>
                        l.id === leaveId ? { ...l, status } : l
                    )
                }));
            };

            const exportToCSV = (type) => {
                let csv = '';
                let filename = '';
 
                if (type === 'users') {
                    csv = '員工代號,姓名,地區,部門,職稱,Email,電話,生日,班別,總特休,已使用特休,剩餘特休\n';
                    data.users.forEach(u => {
                        const usedLeave = data.leaves.filter(l => l.userId === u.id && l.type === '特休' && l.status === '已核准').length;
                        csv += `${u.id},${u.name},${u.region},${u.department},${u.position},${u.email},${u.phone},${u.birthday},${u.shift.join('/')},${u.annualLeave},${usedLeave},${u.annualLeave - usedLeave}\n`;
                    });
                    filename = '人員管理.csv';
                } else if (type === 'vacation') {
                    csv = '員工代號,姓名,地區,部門,班別,';
                    const days = getMonthDays(selectedMonth);
                    days.forEach(day => {
                        csv += `${day.getMonth()+1}/${day.getDate()},`;
                    });
                    csv += '總請假天數\n';

                    data.users.filter(isVisibleStaff).forEach(user => {
                        const userLeaves = data.leaves.filter(l => l.userId === user.id && l.status === '已核准');
                        csv += `${user.id},${user.name},${user.region},${user.department},${user.shift.join('/')},`;
                        days.forEach(day => {
                            const dateStr = formatLocalDate(day);
                            const leave = userLeaves.find(l => dateStr >= l.startDate && dateStr <= l.endDate);
                            csv += `${leave ? leave.type : ''},`;
                        });
                        csv += `${userLeaves.filter(l => parseDateString(l.startDate)?.getMonth() === selectedMonth.getMonth()).length}\n`;
                    });
                    filename = `休假表_${selectedMonth.getFullYear()}年${selectedMonth.getMonth()+1}月.csv`;
                } else if (type === 'compensatory') {
                    csv = '員工代號,姓名,地區,部門,補休(時)已使用,補休(天)已使用\n';
                    data.users.filter(isVisibleStaff).forEach(u => {
                        const compHours = data.leaves.filter(l => l.userId === u.id && l.type === '補休(時)' && l.status === '已核准');
                        const compDays = data.leaves.filter(l => l.userId === u.id && l.type === '補休(天)' && l.status === '已核准');
                        const totalHours = compHours.reduce((sum, l) => sum + (l.hours || 0), 0);
                        csv += `${u.id},${u.name},${u.region},${u.department},${totalHours},${compDays.length}\n`;
                    });
                    filename = '補休表.csv';
                } else if (type === 'schedule') {
                    csv = '日期,標題,內容\n';
                    if (data.schedules && data.schedules.length > 0) {
                        data.schedules.forEach(s => {
                            csv += `${s.date},${s.title || ''},${s.content || ''}\n`;
                        });
                    } else {
                        csv += '目前沒有排程資料\n';
                    }
                    filename = '排程表.csv';
                } else if (type === 'leaves') {
                    csv = '申請日期,員工代號,姓名,地區,部門,假別,開始日期,結束日期,時數,事由,狀態,審核人,審核時間\n';
                    data.leaves.forEach(l => {
                        const user = data.users.find(u => u.id === l.userId);
                        csv += `${new Date(l.submittedAt).toLocaleDateString('zh-TW')},${user?.id || ''},${l.userName},${l.region},${l.department},${l.type},${l.startDate},${l.endDate},${l.hours},${l.reason},${l.status},${l.approvedBy || ''},${l.approvedAt ? new Date(l.approvedAt).toLocaleDateString('zh-TW') : ''}\n`;
                    });
                    filename = '請假紀錄.csv';
                } else if (type === 'annual') {
                    csv = '員工代號,姓名,地區,部門,職稱,總特休天數,已使用天數,剩餘天數,使用日期明細\n';
                    data.users.filter(isVisibleStaff).forEach(u => {
                        const annualLeaves = data.leaves.filter(l => l.userId === u.id && l.type === '特休' && l.status === '已核准');
                        const usedDays = annualLeaves.length;
                        const dates = annualLeaves.map(l => `${l.startDate}~${l.endDate}`).join('; ');
                        csv += `${u.id},${u.name},${u.region},${u.department},${u.position},${u.annualLeave},${usedDays},${u.annualLeave - usedDays},"${dates}"\n`;
                    });
                    filename = '特休總覽.csv';
                }

                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            };

            const getMonthDays = (date) => {
                const days = [];
                const year = date.getFullYear();
                const month = date.getMonth();
                const lastDay = new Date(year, month + 1, 0).getDate();

                for (let d = 1; d <= lastDay; d++) {
                    days.push(new Date(year, month, d));
                }
                return days;
            };

            const isHoliday = (date) => {
                const dateStr = formatLocalDate(date);
                return holidays2026.find(h => h.date === dateStr);
            };

            const formatHolidayLabel = (holidayName = '') => {
                const chars = Array.from(holidayName);
                const length = chars.length;

                let topRowLength = 0;

                if (length === 3) topRowLength = 2;
                else if (length === 4) topRowLength = 2;
                else if (length === 6) topRowLength = 3;
                else return holidayName;

                return (
                    <>
                       {chars.slice(0, topRowLength).join('')}
                       <br />
                       {chars.slice(topRowLength).join('')}
                   </>
                );
                };

            const isWeekend = (date) => {
                return date.getDay() === 0 || date.getDay() === 6;
            };

            const shouldAutoMarkRestDay = (user, date) => {
                if (!user?.autoWeekendHoliday) return false;
                return isWeekend(date) || Boolean(isHoliday(date));
            };

            const shouldAutoMarkRestDayByDateStr = (user, dateStr) => {
                const date = parseDateString(dateStr);
                if (!date) return false;
                return shouldAutoMarkRestDay(user, date);
            };

             const isWithinOpenRange = (date) => {
                const dateStr = formatLocalDate(date);
                const { openStart, openEnd } = data.vacationSettings;
                if (!openStart || !openEnd) return false;
                return dateStr >= openStart && dateStr <= openEnd;
            };

             const getDateRangeList = (startDate, endDate) => {
                if (!startDate || !endDate) return [];
                const cursor = new Date(startDate);
                const last = new Date(endDate);
                const dates = [];

                if (Number.isNaN(cursor.getTime()) || Number.isNaN(last.getTime())) return [];

                while (cursor <= last) {
                    dates.push(formatLocalDate(cursor));
                    cursor.setDate(cursor.getDate() + 1);
                }

                return dates;
            };

            const handleVacationSettingChange = (field, value) => {
                setData(prev => ({
                    ...prev,
                    vacationSettings: {
                        ...prev.vacationSettings,
                        [field]: value
                    }
                }));
            };

             const vacationMarkerOptions = [
                { value: '▲-black', label: '▲ 黑色', symbol: '▲', textClass: 'text-gray-900', activeClass: 'border-gray-800 bg-gray-100' },
                { value: '▲-red', label: '▲ 紅色', symbol: '▲', textClass: 'text-red-600', activeClass: 'border-red-500 bg-red-50' },
                { value: '★-black', label: '★ 黑色', symbol: '★', textClass: 'text-gray-900', activeClass: 'border-gray-800 bg-gray-100' },
                { value: '★-red', label: '★ 紅色', symbol: '★', textClass: 'text-red-600', activeClass: 'border-red-500 bg-red-50' }
            ];

            const getMarkerDisplay = (marker) => {
                if (!marker) return null;
                if (marker.includes('-')) {
                    const [symbol, color] = marker.split('-');
                    return {
                        symbol,
                        className: color === 'red' ? 'text-red-600 font-bold' : 'text-gray-900 font-bold'
                    };
                }
                if (marker === '★') {
                    return { symbol: '★', className: 'text-red-600 font-bold' };
                }
                return { symbol: marker, className: 'text-gray-900 font-bold' };
            };

            const handleToggleVacation = (userId, dateStr) => {
                const targetUser = data.users.find(user => user.id === userId);
                if (targetUser && shouldAutoMarkRestDayByDateStr(targetUser, dateStr)) return;
                if (!currentUser.isAdmin && (!data.vacationSettings.openStart || !data.vacationSettings.openEnd)) return;
                const isOpen = dateStr >= data.vacationSettings.openStart && dateStr <= data.vacationSettings.openEnd;
                if (!currentUser.isAdmin && !isOpen) return;
                if (!currentUser.isAdmin && currentUser.id !== userId) return;
                setData(prev => {
                    const userSchedule = prev.vacationSchedule[userId] || {};
                    const currentMarker = userSchedule[dateStr];
                    const nextMarker = currentMarker === selectedVacationMarker ? '' : selectedVacationMarker;
                    return {
                        ...prev,
                        vacationSchedule: {
                            ...prev.vacationSchedule,
                            [userId]: {
                                ...userSchedule,
                                [dateStr]: nextMarker
                            }
                        }
                    };
                });
            };

            const isVisibleStaff = (user) => user.id !== SUPER_USER.id;

            const baseVacationUsers = data.users
                .filter(user => isVisibleStaff(user))
                .filter(user =>
                    (filterRegion === '全部' || user.region === filterRegion) &&
                    (filterDepartment === '全部' || user.department === filterDepartment) &&
                    (filterShift === '全部' || user.shift.includes(filterShift))
                );

            const visibleVacationUsers = appliedVacationUserFilter.length
                ? baseVacationUsers.filter(user => appliedVacationUserFilter.includes(user.id))
                : baseVacationUsers;

            useEffect(() => {
                const validUserIds = new Set(baseVacationUsers.map(user => user.id));
                setPendingVacationUserFilter(prev => prev.filter(id => validUserIds.has(id)));
                setAppliedVacationUserFilter(prev => prev.filter(id => validUserIds.has(id)));
            }, [filterRegion, filterDepartment, filterShift, data.users]);

            const handleTogglePendingVacationUser = (userId) => {
                setPendingVacationUserFilter(prev => (
                    prev.includes(userId)
                        ? prev.filter(id => id !== userId)
                        : [...prev, userId]
                ));
            };

            const handleApplyVacationUserFilter = () => {
                setAppliedVacationUserFilter(pendingVacationUserFilter);
            };

            const handleClearVacationUserFilter = () => {
                setPendingVacationUserFilter([]);
                setAppliedVacationUserFilter([]);
            };

            const getWorkingCount = (date) => {
                const dateStr = formatLocalDate(date);
                const onLeaveUserIds = new Set(
                    data.leaves
                        .filter(l => l.status === '已核准' && dateStr >= l.startDate && dateStr <= l.endDate)
                        .map(l => l.userId)
                );
                const vacationUserIds = new Set(
                    data.users
                        .filter(user => {
                            const hasCustomMarker = Boolean(data.vacationSchedule[user.id]?.[dateStr]);
                            const hasAutoRestMarker = shouldAutoMarkRestDayByDateStr(user, dateStr);
                            return hasCustomMarker || hasAutoRestMarker;
                        })
                        .map(user => user.id)
                );
                return data.users.filter(user => isVisibleStaff(user) && !onLeaveUserIds.has(user.id) && !vacationUserIds.has(user.id)).length;
            };

            const getWorkingUsersByDate = (dateStr) => {
                const onLeaveUserIds = new Set(
                    data.leaves
                        .filter(l => l.status === '已核准' && dateStr >= l.startDate && dateStr <= l.endDate)
                        .map(l => l.userId)
                );
                const vacationUserIds = new Set(
                   data.users
                        .filter(user => {
                            const hasCustomMarker = Boolean(data.vacationSchedule[user.id]?.[dateStr]);
                            const hasAutoRestMarker = shouldAutoMarkRestDayByDateStr(user, dateStr);
                            return hasCustomMarker || hasAutoRestMarker;
                        })
                        .map(user => user.id)
                );
                return data.users.filter(user => isVisibleStaff(user) && !onLeaveUserIds.has(user.id) && !vacationUserIds.has(user.id));
            };

            const currentViewDateStr = formatLocalDate(workingViewDate);
            const todayWorkingUsers = getWorkingUsersByDate(currentViewDateStr);
            const todayWorkingByDepartment = todayWorkingUsers.reduce((acc, user) => {
                if (!acc[user.department]) acc[user.department] = [];
                acc[user.department].push(user);
                return acc;
            }, {});
            
             const getCompensatoryCellData = (userId, dateStr) => {
                const matchedLeaves = data.leaves.filter(l =>
                    l.userId === userId &&
                    l.status === '已核准' &&
                    (l.type === '補休(時)' || l.type === '補休(天)') &&
                    dateStr >= l.startDate &&
                    dateStr <= l.endDate
                );

                if (matchedLeaves.length === 0) return null;

                const hasDayComp = matchedLeaves.some(l => l.type === '補休(天)');
                const totalHourComp = matchedLeaves
                    .filter(l => l.type === '補休(時)')
                    .reduce((sum, leave) => sum + Number(leave.hours || 0), 0);

                if (hasDayComp && totalHourComp > 0) {
                    return `天/${totalHourComp}h`;
                }

                if (hasDayComp) return '補休天';
                return `${totalHourComp}h`;
            };

            const handleResetData = () => {
                if (window.confirm('確定要重置所有資料嗎?這將清除所有員工和請假紀錄!')) {
                    storageRemove(DATA_STORAGE_KEY);
                    window.location.reload();
                }
            };

            const navigationTabs = [
                { id: 'management', label: '人員管理', icon: Users, admin: true },
                { id: 'todayWorking', label: '當日上班人員', icon: Bell },
                { id: 'vacation', label: '休假表', icon: Calendar },
                { id: 'compensatory', label: '補休表', icon: Clock },
                { id: 'schedule', label: '排程表', icon: Clipboard },
                { id: 'leave', label: '請假', icon: FileText },
                { id: 'annual', label: '特休', icon: Calendar }
            ];
            const monthDays = getMonthDays(selectedMonth);
            const isDesktopMode = uiMode === 'desktop';
            const vacationDayCellWidthClass = isDesktopMode
                ? 'w-[1.55rem] min-w-[1.55rem]'
                : 'w-10 min-w-[2.5rem]';

            const handleStartSession = () => {
                const loginUser = data.users.find(user => user.id === selectedLoginUserId) || data.users[0] || null;
                if (!loginUser) {
                    alert('目前沒有可登入的員工資料，請先新增員工。');
                    return;
                }
                setCurrentUser(loginUser);
                setIsSessionStarted(true);
            };

            if (!isSessionStarted) {
                return (
                    <div className="h-screen w-screen bg-slate-100 flex items-center justify-center p-4">
                        <div className="w-full max-w-xl bg-white rounded-2xl shadow-lg border border-slate-200 p-6 md:p-8 space-y-6">
                            <div>
                                <h1 className="text-2xl md:text-3xl font-bold text-slate-800">員工假勤系統登入</h1>
                                <p className="mt-2 text-slate-500">請先選擇使用者與顯示版本。桌機版/手機版共用同一份資料。</p>
                            </div>

                            <label className="block space-y-2">
                                <span className="text-sm font-medium text-slate-700">登入使用者</span>
                                <select
                                    value={selectedLoginUserId}
                                    onChange={e => setSelectedLoginUserId(e.target.value)}
                                    className="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                >
                                    {data.users.map(user => (
                                        <option key={user.id} value={user.id}>
                                            {user.name}（{user.department}）{user.isAdmin ? ' - 管理員' : ''}
                                        </option>
                                    ))}
                                </select>
                            </label>

                            <div className="space-y-2">
                                <p className="text-sm font-medium text-slate-700">畫面版本</p>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <button
                                        onClick={() => setUiMode('desktop')}
                                        className={`rounded-xl border px-4 py-3 text-left transition-colors ${uiMode === 'desktop' ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-slate-300 hover:bg-slate-50'}`}
                                    >
                                        <p className="font-semibold">桌機版</p>
                                        <p className="text-xs mt-1 text-slate-500">欄位完整、適合大畫面或需要完整管理功能。</p>
                                    </button>
                                    <button
                                        onClick={() => setUiMode('mobile')}
                                        className={`rounded-xl border px-4 py-3 text-left transition-colors ${uiMode === 'mobile' ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-slate-300 hover:bg-slate-50'}`}
                                    >
                                        <p className="font-semibold">手機版</p>
                                        <p className="text-xs mt-1 text-slate-500">字體與間距較大，操作區塊更集中。</p>
                                    </button>
                                </div>
                            </div>

                            <button
                                onClick={handleStartSession}
                                className="w-full rounded-lg bg-indigo-600 text-white py-2.5 font-medium hover:bg-indigo-700"
                            >
                                進入系統
                            </button>
                        </div>
                    </div>
                );
            }

            
            return (
                <div className={`h-screen ${isDesktopMode ? 'min-w-[1200px] w-full text-base' : 'w-screen text-sm md:text-base'} overflow-hidden bg-gray-50`}>
                    <div className="fixed top-0 left-0 right-0 z-30 bg-white">
                    <nav className="bg-white shadow-sm border-b">
                     <div className="w-full px-4 py-4">
                            <div className="flex flex-wrap justify-between items-center gap-3">
                                <div className="flex items-center gap-4 min-w-0">
                                    <div className="flex items-center space-x-3 min-w-0">
                                        <button
                                        onClick={() => setIsMobileMenuOpen(prev => !prev)}
                                        className={`${isDesktopMode ? 'hidden' : 'md:hidden'} p-2 rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50`}
                                        aria-label="切換選單"
                                    >
                                        ☰
                                    </button>
                                        <div className="bg-indigo-600 w-10 h-10 rounded-lg flex items-center justify-center">
                                            <Users size={24} className="text-white" />
                                        </div>
                                        <div>
                                            <h1 className="text-xl font-bold">員工假勤系統</h1>
                                           <p className="text-sm md:text-base text-gray-500">歡迎, {currentUser.name} {currentUser.isAdmin && '(管理員)'}</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex items-center space-x-2 md:space-x-4">
                                    <button
                                        onClick={() => setUiMode(prev => prev === 'desktop' ? 'mobile' : 'desktop')}
                                        className="px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100"
                                    >
                                        切換為{isDesktopMode ? '手機版' : '桌機版'}
                                    </button>
                                     {!currentUser.isAdmin && (
                                        <button onClick={handlePromoteCurrentUser} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                            設為最高權限
                                        </button>
                                    )}
                                    <button onClick={handleSuperUserLogin} className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                                        輸入密碼進入 GoldBricks
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>

                   </div>

                   {!isDesktopMode && isMobileMenuOpen && (
                        <button
                            onClick={() => setIsMobileMenuOpen(false)}
                            className="fixed inset-0 z-30 bg-black/30 md:hidden"
                            aria-label="關閉選單"
                        />
                    )}

                    <aside
                        className={isDesktopMode
                            ? 'fixed top-20 left-0 bottom-0 z-20 w-64 bg-white border-r shadow-sm overflow-y-auto pt-0 translate-x-0'
                            : `fixed top-0 left-0 bottom-0 z-40 w-64 max-w-[85vw] bg-white border-r shadow-sm overflow-y-auto pt-24 transform transition-transform duration-200 md:top-20 md:z-20 md:pt-0 md:w-56 lg:w-64 md:translate-x-0 ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}
                    >
                        <div className="p-3 space-y-1">
                           {navigationTabs.map(tab => {
                                if (tab.admin && !currentUser.isAdmin) return null;
                                const Icon = tab.icon;
                                return (
                                    <button
                                        key={tab.id}
                                        onClick={() => {
                                            setActiveTab(tab.id);
                                            if (!isDesktopMode) setIsMobileMenuOpen(false);
                                        }}
                                        className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors text-left ${
                                            activeTab === tab.id
                                                ? 'bg-indigo-50 text-indigo-700'
                                                : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'
                                        }`}
                                    >
                                        <Icon size={18} />
                                        <span className="font-medium">{tab.label}</span>
                                    </button>
                                );
                            })}
                        </div>
                    </aside>

                      <div
                        className={`fixed right-0 bottom-0 ${isDesktopMode ? 'left-64' : 'left-0 md:left-56 lg:left-64'} ${activeTab === 'vacation' ? 'overflow-hidden' : 'overflow-y-auto'} px-4 md:px-5 lg:px-6 py-6 pt-4`}
                        style={{
                            top: '7rem',
                            transform: 'translateY(-22px)'
                        }}
                    >
                        {activeTab === 'todayWorking' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">當日上班人員</h2>
                                   <div className="flex items-center gap-2">
                                        <button
                                            onClick={() => setWorkingViewDate(prev => new Date(prev.getFullYear(), prev.getMonth(), prev.getDate() - 1))}
                                            className="px-3 py-1 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50"
                                        >
                                            上一頁(昨天)
                                        </button>
                                        <span className="text-base text-gray-500">日期：{currentViewDateStr}</span>
                                        <button
                                            onClick={() => setWorkingViewDate(prev => new Date(prev.getFullYear(), prev.getMonth(), prev.getDate() + 1))}
                                            className="px-3 py-1 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50"
                                        >
                                            下一頁(明天)
                                        </button>
                                    </div>
                                </div>
                                <div className="bg-white rounded-lg shadow p-4">
                                    <p className="text-lg font-medium text-indigo-700 mb-3">今日上班總人數：{todayWorkingUsers.length} 人</p>
                                    {todayWorkingUsers.length === 0 ? (
                                        <p className="text-gray-500">今日無上班人員。</p>
                                    ) : (
                                        <div className="space-y-4">
                                            {Object.entries(todayWorkingByDepartment).map(([department, users]) => (
                                                <div key={department} className="border border-gray-100 rounded-lg p-3">
                                                    <h3 className="text-lg font-semibold text-gray-800 mb-2">{department}</h3>
                                                    <div className="flex flex-wrap gap-2">
                                                        {users.map(user => (
                                                            <span key={user.id} className="px-3 py-1 bg-indigo-50 text-indigo-700 rounded-full text-sm md:text-base">
                                                                {user.name}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'management' && currentUser.isAdmin && (
                            <div className="space-y-4">
                                <div className="flex justify-between">
                                    <h2 className="text-2xl font-bold">人員管理</h2>
                                    <div className="flex space-x-2">
                                       <button
                                            onClick={() => showAddUser ? setShowAddUser(false) : openAddUserByCategory(selectedManagementCategory || managementRegionOptions[0])}
                                            className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                        >
                                            {showAddUser ? '取消新增' : '+ 新增員工'}
                                        </button>
                                        <button onClick={() => exportToCSV('users')} className="px-4 py-2 bg-green-600 text-white rounded-lg">
                                            匯出Excel
                                        </button>
                                    </div>
                                </div>

                                {showAddUser && (
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-lg font-bold mb-4">{editingUser ? '編輯員工' : '新增員工'}</h3>
                                        <form onSubmit={handleAddUser} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">員工代號 *</label>
                                                <input
                                                    type="text"
                                                    value={newUserForm.id}
                                                    onChange={(e) => setNewUserForm({...newUserForm, id: e.target.value})}
                                                    className="w-72 max-w-full px-3 py-2 border rounded-lg"
                                                    placeholder="例如: E003"
                                                    required
                                                />
                                                <p className="text-xs text-gray-500 mt-1">請輸入唯一的員工代號</p>
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">帳號</label>
                                                <input
                                                    type="text"
                                                    value={newUserForm.username}
                                                    onChange={(e) => setNewUserForm({...newUserForm, username: e.target.value})}
                                                    className="w-72 max-w-full px-3 py-2 border rounded-lg"
                                                    placeholder="登入用帳號（可留空）"
                                                />
                                            </div>

                                            <div>
                                               <label className="block text-sm md:text-base font-medium mb-1">姓名 *</label>
                                                <input
                                                    type="text"
                                                    value={newUserForm.name}
                                                    onChange={(e) => setNewUserForm({...newUserForm, name: e.target.value})}
                                                    className="w-72 max-w-full px-3 py-2 border rounded-lg"
                                                    required
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">地區</label>
                                                <select
                                                    value={newUserForm.region}
                                                    onChange={(e) => setNewUserForm({...newUserForm, region: e.target.value})}
                                                    className="w-72 max-w-full px-3 py-2 border rounded-lg"
                                                >
                                                    {managementRegionOptions.map(region => (
                                                        <option key={region}>{region}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">部門</label>
                                                <select
                                                    value={newUserForm.department}
                                                    onChange={(e) => setNewUserForm({...newUserForm, department: e.target.value})}
                                                    className="w-72 max-w-full px-3 py-2 border rounded-lg"
                                                >
                                                     {departmentOptions.map(department => (
                                                        <option key={department}>{department}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">職稱</label>
                                                <input
                                                    type="text"
                                                    value={newUserForm.position}
                                                    onChange={(e) => setNewUserForm({...newUserForm, position: e.target.value})}
                                                    className="w-72 max-w-full px-3 py-2 border rounded-lg"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">Email</label>
                                                <div className="flex items-center rounded-lg border overflow-hidden">
                                                    <input
                                                        type="text"
                                                        value={newUserForm.email}
                                                        onChange={(e) => setNewUserForm({...newUserForm, email: e.target.value})}
                                                        className="w-full px-3 py-2 outline-none"
                                                        placeholder="請輸入帳號前綴"
                                                    />
                                                    <span className="px-3 py-2 bg-gray-100 text-gray-600 text-sm whitespace-nowrap">{COMPANY_EMAIL_DOMAIN}</span>
                                                </div>
                                                <p className="text-xs text-gray-500 mt-1">系統會自動補上公司網域</p>
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">電話</label>
                                                <input
                                                    type="tel"
                                                    value={newUserForm.phone}
                                                    onChange={(e) => setNewUserForm({...newUserForm, phone: e.target.value})}
                                                    className="w-72 max-w-full px-3 py-2 border rounded-lg"
                                                    placeholder="0912-345-678"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">生日 (月/日)</label>
                                                <input
                                                    type="text"
                                                    value={newUserForm.birthday}
                                                    onChange={(e) => setNewUserForm({...newUserForm, birthday: e.target.value})}
                                                    className="w-72 max-w-full px-3 py-2 border rounded-lg"
                                                    placeholder="例如: 05/15 "
                                                />
                                                <p className="text-xs text-gray-500 mt-1">格式: 月/日 (不需要輸入年份)</p>
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">班別</label>
                                                <div className="flex space-x-4 mt-2">
                                                    <label className="flex items-center space-x-2">
                                                        <input
                                                            type="checkbox"
                                                            checked={newUserForm.shift.includes('早')}
                                                            onChange={() => toggleShift('早')}
                                                            className="w-4 h-4"
                                                        />
                                                        <span>早班</span>
                                                    </label>
                                                    <label className="flex items-center space-x-2">
                                                        <input
                                                            type="checkbox"
                                                            checked={newUserForm.shift.includes('晚')}
                                                            onChange={() => toggleShift('晚')}
                                                            className="w-4 h-4"
                                                        />
                                                        <span>晚班</span>
                                                    </label>
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-sm md:text-base font-medium mb-1">年度特休天數</label>
                                                <input
                                                    type="number"
                                                    value={newUserForm.annualLeave}
                                                    onChange={(e) => setNewUserForm({...newUserForm, annualLeave: parseInt(e.target.value) || 0})}
                                                    className="w-72 max-w-full px-3 py-2 border rounded-lg"
                                                    min="0"
                                                    max="30"
                                                />
                                            </div>

                                            <div className="md:col-span-2">
                                                <label className="flex items-center space-x-2">
                                                    <input
                                                        type="checkbox"
                                                        checked={newUserForm.autoWeekendHoliday}
                                                        onChange={(e) => setNewUserForm({...newUserForm, autoWeekendHoliday: e.target.checked})}
                                                        className="w-4 h-4"
                                                    />
                                                    <span className="text-sm md:text-base font-medium">週休二日 & 國定假日(休假表自動連動)</span>
                                                </label>
                                            </div>

                                            <div className="md:col-span-2">
                                                <label className="flex items-center space-x-2">
                                                    <input
                                                        type="checkbox"
                                                        checked={newUserForm.isAdmin}
                                                        onChange={(e) => setNewUserForm({...newUserForm, isAdmin: e.target.checked})}
                                                        className="w-4 h-4"
                                                    />
                                                     <span className="text-sm md:text-base font-medium">設為管理員</span>
                                                    <span className="text-xs text-gray-500">(管理員可以管理所有員工和審核請假)</span>
                                                </label>
                                            </div>

                                           {newUserForm.isAdmin && (
                                                <div className="md:col-span-2 rounded-lg border border-indigo-100 bg-indigo-50 p-4">
                                                    <div className="flex items-center justify-between">
                                                        <h4 className="text-sm md:text-base font-semibold text-indigo-700">權限管理</h4>
                                                        <span className="text-xs text-gray-500">僅勾選的地區/部門可審核或編輯員工資料</span>
                                                    </div>
                                                     <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        <div>
                                                            <p className="text-sm md:text-base font-medium text-gray-700 mb-2">地區</p>
                                                            <div className="space-y-2">
                                                                {managementRegionOptions.map(region => (
                                                                    <label key={region} className="flex items-center space-x-2 text-sm md:text-base">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={newUserForm.permissionRegions.includes(region)}
                                                                            onChange={() => togglePermission('region', region)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span>{region}</span>
                                                                    </label>
                                                                ))}
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <p className="text-sm md:text-base font-medium text-gray-700 mb-2">部門</p>
                                                            <div className="space-y-2">
                                                                {departmentOptions.map(department => (
                                                                    <label key={department} className="flex items-center space-x-2 text-sm md:text-base">
                                                                        <input
                                                                            type="checkbox"
                                                                            checked={newUserForm.permissionDepartments.includes(department)}
                                                                            onChange={() => togglePermission('department', department)}
                                                                            className="w-4 h-4"
                                                                        />
                                                                        <span>{department}</span>
                                                                    </label>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                           )}

                                            <div className="md:col-span-2 flex space-x-2">
                                               <button
                                                    type="submit"
                                                    className="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700"
                                                >
                                                    {editingUser ? '更新員工' : '確認新增'}
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => {
                                                        setShowAddUser(false);
                                                        setEditingUser(null);
                                                        setNewUserForm({
                    id: '',
                    username: '',
                                                            name: '',
                                                            region: selectedManagementCategory || managementRegionOptions[0],
                                                            department: departmentOptions[0],
                                                            position: '專員',
                                                            email: '',
                                                            phone: '',
                                                            birthday: '',
                                                            shift: [],
                                                            annualLeave: 10,
                                                            autoWeekendHoliday: false,
                                                            isAdmin: false,
                                                            permissionRegions: [...managementRegionOptions],
                                                            permissionDepartments: [...departmentOptions]
                                                        });
                                                    }}
                                                    className="px-6 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300"
                                                >
                                                    取消
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                )}

                                 <div className="bg-white rounded-lg shadow p-4 space-y-4">
                                    <div className="flex flex-wrap items-center gap-2">
                                        <input
                                            type="text"
                                            value={newCategoryName}
                                            onChange={(e) => setNewCategoryName(e.target.value)}
                                            placeholder="新增收合類別"
                                            className="px-3 py-2 border rounded-lg"
                                        />
                                        <button
                                            onClick={handleAddManagementCategory}
                                            className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                        >
                                            新增收合類別
                                        </button>
                                    </div>

                                    {managementRegionOptions.map(category => {
                                        const categoryUsers = data.users.filter(user => user.region === category);
                                        const isExpanded = expandedCategories[category] ?? false;

                                        return (
                                            <div key={category} className="border border-gray-200 rounded-lg overflow-hidden">
                                                <button
                                                    onClick={() => handleToggleCategory(category)}
                                                    className="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50"
                                                >
                                                    <div className="text-left">
                                                        <p className="font-semibold">{category}</p>
                                                        <p className="text-xs text-gray-500">共 {categoryUsers.length} 人</p>
                                                    </div>
                                                    <span className="text-sm text-gray-500">{isExpanded ? '收合 ▲' : '展開 ▼'}</span>
                                                </button>

                                                {isExpanded && (
                                                    <div className="border-t border-gray-200 p-3 space-y-3">
                                                        <div className="flex justify-end">
                                                            <button
                                                                onClick={() => openAddUserByCategory(category)}
                                                                className="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                                            >
                                                                在 {category} 新增人員
                                                            </button>
                                                        </div>

                                                        {categoryUsers.length === 0 ? (
                                                            <p className="text-gray-500">目前沒有人員，請點擊上方按鈕新增。</p>
                                                        ) : (
                                                             <div className="space-y-2">
                                                                {Object.entries(categoryUsers.reduce((acc, user) => {
                                                                    if (!acc[user.department]) acc[user.department] = [];
                                                                    acc[user.department].push(user);
                                                                    return acc;
                                                                }, {})).map(([department, departmentUsers]) => {
                                                                    const departmentKey = `${category}__${department}`;
                                                                    const isDepartmentExpanded = expandedDepartments[departmentKey] ?? false;

                                                                    return (
                                                                        <div key={department} className="border border-gray-200 rounded-lg overflow-hidden">
                                                                            <button
                                                                                onClick={() => handleToggleDepartment(category, department)}
                                                                                className="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50"
                                                                            >
                                                                                <div className="text-left">
                                                                                    <p className="font-medium text-gray-800">{department}</p>
                                                                                    <p className="text-xs text-gray-500">共 {departmentUsers.length} 人</p>
                                                                                </div>
                                                                                <span className="text-sm text-gray-500">{isDepartmentExpanded ? '收合 ▲' : '展開 ▼'}</span>
                                                                            </button>

                                                                            {isDepartmentExpanded && (
                                                                                <div className="overflow-x-auto border-t border-gray-200">
                                                                                    <table className="w-full">
                                                                                        <thead className="bg-gray-50">
                                                                                            <tr>
                                                                                                <th className="px-4 py-3 text-left text-xs">員工代號</th>
                                                                                                <th className="px-4 py-3 text-left text-xs">姓名</th>
                                                                                                <th className="px-4 py-3 text-left text-xs">職稱</th>
                                                                                                <th className="px-4 py-3 text-left text-xs">Email</th>
                                                                                                <th className="px-4 py-3 text-left text-xs">電話</th>
                                                                                                <th className="px-4 py-3 text-left text-xs">班別</th>
                                                                                                <th className="px-4 py-3 text-left text-xs">休假表連動</th>
                                                                                                <th className="px-4 py-3 text-left text-xs">操作</th>
                                                                                            </tr>
                                                                                        </thead>
                                                                                        <tbody>
                                                                                            {departmentUsers.map(user => {
                                                                                                const canManage = canManageUser(user);
                                                                                                return (
                                                                                                    <tr key={user.id}>
                                                                                                        <td className="px-4 py-3">{user.id}</td>
                                                                                                        <td className="px-4 py-3">{user.name}</td>
                                                                                                        <td className="px-4 py-3">{user.position}</td>
                                                                                                        <td className="px-4 py-3">{user.email}</td>
                                                                                                        <td className="px-4 py-3">{user.phone}</td>
                                                                                                        <td className="px-4 py-3">
                                                                                                            <div className="flex space-x-1">
                                                                                                                {user.shift.includes('早') && <span className="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">早</span>}
                                                                                                                {user.shift.includes('晚') && <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">晚</span>}
                                                                                                            </div>
                                                                                                        </td>
                                                                                                        <td className="px-4 py-3">
                                                                                                            {user.autoWeekendHoliday ? (
                                                                                                                <span className="px-2 py-1 bg-emerald-100 text-emerald-700 text-xs rounded">週休/國定已連動</span>
                                                                                                            ) : (
                                                                                                                <span className="text-xs text-gray-400">未啟用</span>
                                                                                                            )}
                                                                                                        </td>
                                                                                                        <td className="px-4 py-3">
                                                                                                            <div className="flex space-x-2">
                                                                                                                <button onClick={() => canManage && handleEditUser(user)} className={`text-blue-600 ${canManage ? 'hover:text-blue-800' : 'opacity-40 cursor-not-allowed'}`} disabled={!canManage}>
                                                                                                                    <Edit2 size={16} />
                                                                                                                </button>
                                                                                                                <button onClick={() => canManage && handleDeleteUser(user.id)} className={`text-red-600 ${canManage ? 'hover:text-red-800' : 'opacity-40 cursor-not-allowed'}`} disabled={!canManage}>
                                                                                                                    <Trash2 size={16} />
                                                                                                                </button>
                                                                                                            </div>
                                                                                                        </td>
                                                                                                    </tr>
                                                                                                );
                                                                                            })}
                                                                                        </tbody>
                                                                                    </table>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                          )}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>

                                <div className="bg-white rounded-lg shadow p-4">
                                    <h3 className="text-lg font-bold mb-4">操作紀錄</h3>
                                    <div className="space-y-2 max-h-64 overflow-y-auto">
                                        {data.auditLogs.slice(-10).reverse().map((log, idx) => (
                                            <div key={idx} className="text-sm md:text-base p-2 bg-gray-50 rounded">
                                                <span className="text-gray-500">{new Date(log.timestamp).toLocaleString('zh-TW')}</span>
                                                {' - '}
                                                <span className="font-medium">{log.user}</span>
                                                {' '}
                                                <span className="text-indigo-600">{log.action}</span>
                                                {' - '}
                                                <span>{log.details}</span>
                                            </div>
                                        ))}
                                        {data.auditLogs.length === 0 && (
                                            <p className="text-center text-gray-500 py-4">目前沒有操作紀錄</p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'vacation' && (
                            <div className="flex h-full min-h-0 flex-col gap-4 overflow-hidden">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">休假表</h2>
                                    <div className="flex space-x-2">
                                        <select
                                            value={filterRegion}
                                            onChange={(e) => setFilterRegion(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option value="全部">全部</option>
                                            <option>新竹區</option>
                                            <option>台中區</option>
                                            <option>嘉義區</option>
                                        </select>
                                        <select
                                            value={filterDepartment}
                                            onChange={(e) => setFilterDepartment(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option value="全部">全部</option>
                                            <option>管理部</option>
                                            <option>TSE</option>
                                            <option>FAE</option>
                                            <option>新場</option>
                                            <option>倉管</option>
                                            <option>RD</option>
                                            <option>線上客服</option>
                                        </select>
                                        <select
                                            value={filterShift}
                                            onChange={(e) => setFilterShift(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option value="全部">全部</option>
                                            <option>早</option>
                                            <option>晚</option>
                                        </select>
                                        <button
                                            onClick={() => exportToCSV('vacation')}
                                            className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                        >
                                            <Download size={18} />
                                            <span>匯出Excel</span>
                                        </button>
                                    </div>
                                </div>

                               <div className="bg-white rounded-lg shadow p-4 flex flex-1 min-h-0 flex-col">
                                    {currentUser.isAdmin && (
                                        <div className="mb-4 rounded-lg border border-indigo-100 bg-indigo-50 p-3">
                                            <button
                                                type="button"
                                                onClick={() => setShowVacationSettings((prev) => !prev)}
                                                className="flex w-full items-center justify-between text-left"
                                            >
                                                <span className="text-sm md:text-base font-medium text-indigo-700">班表開放日期設定 (管理員)</span>
                                                <span className="text-xs text-indigo-600">{showVacationSettings ? '收合 ▲' : '展開 ▼'}</span>
                                            </button>

                                            {showVacationSettings && (
                                                <div className="mt-3 flex flex-wrap gap-3 items-center">
                                                    <div className="flex items-center space-x-2">
                                                        <label className="text-sm md:text-base text-gray-700">開始</label>
                                                        <input
                                                            type="date"
                                                            value={data.vacationSettings.openStart}
                                                            onChange={(e) => handleVacationSettingChange('openStart', e.target.value)}
                                                            className="px-3 py-2 border rounded-lg"
                                                        />
                                                    </div>
                                                    <div className="flex items-center space-x-2">
                                                        <label className="text-sm md:text-base text-gray-700">結束</label>
                                                        <input
                                                            type="date"
                                                            value={data.vacationSettings.openEnd}
                                                            onChange={(e) => handleVacationSettingChange('openEnd', e.target.value)}
                                                            className="px-3 py-2 border rounded-lg"
                                                        />
                                                    </div>
                                                    <div className="flex items-center space-x-2">
                                                        <label className="text-sm md:text-base text-gray-700">本月可休天數</label>
                                                        <input
                                                            type="number"
                                                            min="0"
                                                            value={data.vacationSettings.monthlyVacationDays}
                                                            onChange={(e) => handleVacationSettingChange('monthlyVacationDays', e.target.value)}
                                                            className="w-24 px-3 py-2 border rounded-lg"
                                                        />
                                                        <span className="text-sm md:text-base text-gray-600">天</span>
                                                    </div>
                                                    <span className="text-xs text-gray-600">
                                                        開放期間內員工可自行編輯休假日
                                                    </span>
                                                </div>
                                                )}
                                        </div>
                                    )}
                                    <div className="mb-4 flex flex-wrap items-center gap-3 text-sm md:text-base text-gray-600">
                                        <div className="flex flex-wrap items-center gap-2">
                                            <span className="font-medium text-gray-700">休假符號:</span>
                                           {vacationMarkerOptions.map(option => (
                                                <button
                                                    key={option.value}
                                                    onClick={() => setSelectedVacationMarker(option.value)}
                                                    className={`px-2 py-1 rounded border ${selectedVacationMarker === option.value ? option.activeClass : 'border-gray-200'}`}
                                                >
                                                    <span className={`${option.textClass} font-bold`}>{option.symbol}</span> {option.label.split(' ')[1]}
                                                </button>
                                            ))}
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            {data.vacationSettings.openStart && data.vacationSettings.openEnd
                                                ? `開放期間: ${data.vacationSettings.openStart} ~ ${data.vacationSettings.openEnd}`
                                                : '尚未設定開放日期'}
                                        </div>
                                          <div className="text-sm md:text-base text-gray-600">
                                            本月可休: {data.vacationSettings.monthlyVacationDays || '未設定'} 天
                                        </div>
                                        <div className="flex flex-wrap items-center gap-3 rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-xs text-gray-600">
                                            <span className="font-semibold text-gray-700">圖例說明:</span>
                                            <span className="flex items-center gap-1">
                                                <span className="inline-block w-3 h-3 bg-red-200 border border-red-400"></span>
                                                國定假日
                                            </span>
                                            <span className="flex items-center gap-1">
                                                <span className="inline-block w-3 h-3 bg-blue-200 border border-blue-400"></span>
                                                週末
                                            </span>
                                            <span className="flex items-center gap-1">
                                                <span className="inline-block w-3 h-3 bg-orange-100 border border-orange-300"></span>
                                                已核准請假
                                            </span>
                                            <span className="flex items-center gap-1">
                                                <span className="inline-block w-3 h-3 bg-indigo-50 border"></span>
                                                我的資料
                                            </span>
                                        </div>
                                    </div>
                                    <div className="bg-white pb-3">
                                        <div className="flex items-center justify-between gap-2 mb-4">
                                            <button onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() - 1))} className="px-3 md:px-4 py-2 bg-gray-100 rounded text-base md:text-lg">
                                                上個月
                                            </button>
                                            <h3 className="text-2xl md:text-xl font-bold whitespace-nowrap">
                                                {selectedMonth.getFullYear()}年 {selectedMonth.getMonth() + 1}月
                                            </h3>
                                            <button onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() + 1))} className="px-3 md:px-4 py-2 bg-gray-100 rounded text-base md:text-lg">
                                                下個月
                                            </button>
                                        </div>
                                        {appliedVacationUserFilter.length > 0 && (
                                            <p className="mb-2 text-xs md:text-sm text-indigo-600">已套用人員篩選，共 {visibleVacationUsers.length} 人</p>
                                        )}
                                    </div>
                                    
                                    <div className={`flex-1 ${isDesktopMode ? 'min-h-[68vh]' : 'min-h-[56vh]'} overflow-x-auto overflow-y-auto rounded-lg border border-gray-200 touch-pan-x`}>
                                        <table className="min-w-full border-collapse text-xs md:text-sm table-auto">
                                           <thead className="sticky top-0 z-30">
                                                <tr>
                                                   <th rowSpan={3} className="border-2 border-gray-400 p-1.5 bg-gray-200 z-30 w-20 text-xs md:text-sm align-top">
                                                       <div className="font-semibold">人員編制</div>
                                                       <div className="mt-2 flex flex-col gap-1.5">
                                                           <button
                                                               onClick={handleClearVacationUserFilter}
                                                               className="px-2 py-1 bg-indigo-200 text-indigo-800 rounded hover:bg-indigo-300 text-xs md:text-sm font-semibold"
                                                           >
                                                               清除
                                                           </button>
                                                           <button
                                                               onClick={handleApplyVacationUserFilter}
                                                               className="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs md:text-sm font-semibold"
                                                           >
                                                               完成
                                                           </button>
                                                       </div>
                                                   </th>
                                                  <th rowSpan={3} className="border-2 border-gray-400 p-1.5 bg-gray-200 z-30 w-28 text-xs md:text-sm align-top">
                                                       <div className="space-y-2">
                                                           <div className="flex items-center justify-center gap-2">
                                                               <span>人員</span>
                                                               <span className="text-xs md:text-sm text-gray-600">班別</span>
                                                           </div>
                                                           <div>部門</div>
                                                       </div>
                                                   </th>
                                                    {monthDays.map(day => {
                                                        const holiday = isHoliday(day);
                                                        const weekend = isWeekend(day);
                                                        const dayName = ['日','一','二','三','四','五','六'][day.getDay()];
                                                        return (
                                                            <th
                                                                key={`week-${day.toISOString()}`}
                                                                className={`border-2 p-1 text-center text-xs md:text-sm font-bold ${isDesktopMode ? 'w-[2.5rem] min-w-[2.5rem]' : 'w-10 min-w-[2.5rem]'} ${
                                                                    holiday ? 'bg-red-200 text-red-900 border-red-400' :
                                                                    weekend ? 'bg-blue-200 text-blue-900 border-blue-400' :
                                                                    'bg-gray-50 border-gray-300'
                                                                }`}
                                                            >
                                                                {dayName}
                                                            </th>
                                                        );
                                                    })}
                                                 <th className="border-2 border-gray-400 p-1.5 bg-yellow-100 font-bold sticky right-0 z-20 w-[8rem] min-w-[8rem] max-w-[8rem] whitespace-nowrap text-xs md:text-sm">已選天數</th>
                                                </tr>
                                                <tr>
                                                    {monthDays.map(day => {
                                                        const holiday = isHoliday(day);
                                                        const weekend = isWeekend(day);
                                                        return (
                                                            <th
                                                                key={`date-${day.toISOString()}`}
                                                                className={`border-2 p-1 text-center text-xs md:text-sm font-bold ${vacationDayCellWidthClass} ${
                                                                    holiday ? 'bg-red-100 text-red-700 border-red-300' :
                                                                    weekend ? 'bg-blue-100 text-blue-700 border-blue-300' :
                                                                    'bg-gray-50 border-gray-300'
                                                                }`}
                                                            >
                                                                {day.getDate()}
                                                            </th>
                                                        );
                                                    })}
                                                    <th className="border-2 border-gray-400 p-2 bg-yellow-100 sticky right-0 z-20"></th>
                                                </tr>
                                                <tr>
                                                    {monthDays.map(day => {
                                                        const holiday = isHoliday(day);
                                                        const weekend = isWeekend(day);
                                                        return (
                                                            <th
                                                                key={`note-${day.toISOString()}`}
                                                                 className={`border-2 p-1 text-center text-[10px] md:text-xs leading-tight ${vacationDayCellWidthClass} ${
                                                                    holiday ? 'bg-red-200 text-red-800 border-red-300 font-medium' :
                                                                    weekend ? 'bg-blue-100 text-blue-700 border-blue-300' :
                                                                    'bg-gray-50 border-gray-300'
                                                                }`}
                                                            >
                                                                {holiday ? <span className="leading-tight inline-block">{formatHolidayLabel(holiday.name)}</span> : ''}
                                                            </th>
                                                        );
                                                    })}
                                                    <th className="border-2 border-gray-400 p-2 bg-yellow-100 sticky right-0 z-20"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {visibleVacationUsers
                                                    .map((user, userIndex) => {
                                                       const userLeaves = data.leaves.filter(l =>
                                                            l.userId === user.id &&
                                                            l.status === '已核准' &&
                                                            parseDateString(l.startDate)?.getMonth() === selectedMonth.getMonth()
                                                        );
                                                        const isCurrentUser = user.id === currentUser.id;
                                                        const markerCount = monthDays.filter(day => {
                                                            const dateStr = formatLocalDate(day);
                                                            const hasCustomMarker = Boolean(data.vacationSchedule[user.id]?.[dateStr]);
                                                            const hasAutoRestMarker = shouldAutoMarkRestDay(user, day);
                                                            return hasCustomMarker || hasAutoRestMarker;
                                                        }).length;
                                                        
                                                        return (
                                                            <tr key={user.id} className={`h-16 ${isCurrentUser ? 'bg-indigo-50' : ''}`}>
                                                                <td className="border-2 border-gray-300 p-1.5 text-center bg-white z-10">
                                                                    <button
                                                                        type="button"
                                                                        role="switch"
                                                                        aria-checked={pendingVacationUserFilter.includes(user.id)}
                                                                        onClick={() => handleTogglePendingVacationUser(user.id)}
                                                                        aria-label={`篩選${user.name}`}
                                                                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1 ${
                                                                            pendingVacationUserFilter.includes(user.id)
                                                                                ? 'bg-indigo-600'
                                                                                : 'bg-gray-300'
                                                                        }`}
                                                                    >
                                                                        <span
                                                                            className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                                                                                pendingVacationUserFilter.includes(user.id)
                                                                                    ? 'translate-x-6'
                                                                                    : 'translate-x-1'
                                                                            }`}
                                                                        />
                                                                    </button>
                                                                </td>
                                                                <td className="border-2 border-gray-300 p-2 font-medium bg-white z-20 align-top">
                                                                    <div className="flex items-center justify-between gap-2">
                                                                        <div>
                                                                            {user.name}
                                                                            {isCurrentUser && <span className="ml-1 text-xs bg-indigo-600 text-white px-2 py-0.5 rounded">我</span>}
                                                                        </div>
                                                                        <div className="flex flex-wrap items-center justify-end gap-1">
                                                                            {user.shift.includes('早') && (
                                                                                <span className="px-1 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded">早</span>
                                                                            )}
                                                                            {user.shift.includes('晚') && (
                                                                                <span className="px-1 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">晚</span>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                   <div className="mt-2 text-xs text-gray-600">{user.department}</div>
                                                                </td>
                                                                 {monthDays.map(day => {
                                                                    const dateStr = formatLocalDate(day);
                                                                    const leave = userLeaves.find(l =>
                                                                        dateStr >= l.startDate && dateStr <= l.endDate
                                                                    );
                                                                    const holiday = isHoliday(day);
                                                                    const weekend = isWeekend(day);
                                                                    const customMarker = data.vacationSchedule[user.id]?.[dateStr];
                                                                    const autoRestMarker = shouldAutoMarkRestDay(user, day);
                                                                    const isOpen = isWithinOpenRange(day);
                                                                    const isEditable = !autoRestMarker && (currentUser.isAdmin || (isOpen && isCurrentUser));
                                                                    const markerDisplay = getMarkerDisplay(customMarker);

                                                                    return (
                                                                        <td
                                                                            key={day.toISOString()}
                                                                            className={`border p-1 text-center h-10 ${vacationDayCellWidthClass} ${
                                                                                leave ? 'bg-orange-100 text-orange-900 font-bold border-orange-300' :
                                                                                holiday ? 'bg-red-50 border-red-200' :
                                                                                weekend ? 'bg-blue-50 border-blue-200' :
                                                                                     'border-gray-200'
                                                                            } ${isEditable ? 'cursor-pointer hover:bg-indigo-50' : ''}`}
                                                                            onClick={() => handleToggleVacation(user.id, dateStr)}
                                                                            title={isEditable ? '點擊設定休假標記' : ''}
                                                                        >
                                                                                                                      {leave ? (
                                                                                <span className="text-purple-700 font-semibold">請</span>
                                                                            ) : autoRestMarker ? (
                                                                                <span className="text-emerald-700 font-bold">休</span>
                                                                            ) : markerDisplay ? (
                                                                                <span className={markerDisplay.className}>
                                                                                    {markerDisplay.symbol}
                                                                                </span>
                                                                            ) : ''}
                                                                        </td>
                                                                    );
                                                                })}
                                                                <td className="border-2 border-gray-300 p-1.5 text-center font-bold text-sm text-indigo-700 bg-yellow-50 sticky right-0 z-10 w-[8rem] min-w-[8rem] max-w-[8rem] whitespace-nowrap">
                                                                    {markerCount}
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                               </tbody>
                                            <tfoot className="sticky bottom-0 z-20">
                                                <tr className="bg-green-50">
                                                    <td className="border-2 border-gray-400 p-1.5 bg-green-100"></td>
                                                    <td className="border-2 border-gray-400 p-1.5 font-bold text-center bg-green-100">上班人數</td>
                                                    {monthDays.map(day => {
                                                        return (
                                                            <td
                                                                key={`count-${day.toISOString()}`}
                                                                className={`border-2 border-gray-300 p-2 text-center font-bold text-green-700 bg-green-50 sticky bottom-2 z-20 ${vacationDayCellWidthClass}`}
                                                            >
                                                                {getWorkingCount(day)}
                                                               </td>
                                                        );
                                                    })}
                                                    <td className="border-2 border-gray-400 p-1.5 bg-green-100"></td>
                                                </tr>
                                             </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'leave' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">請假申請</h2>
                                    <button
                                        onClick={() => exportToCSV('leaves')}
                                        className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        <Download size={18} />
                                        <span>匯出Excel</span>
                                    </button>
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-lg font-bold mb-4">新增請假</h3>
                                        <form onSubmit={handleSubmitLeave} className="space-y-4">
                                            <input type="text" value={currentUser.name} disabled className="w-72 max-w-full px-3 py-2 border rounded bg-gray-50" />

                                            <select value={newLeaveForm.type} onChange={(e) => setNewLeaveForm({...newLeaveForm, type: e.target.value})} className="w-72 max-w-full px-3 py-2 border rounded">
                                                <option>特休</option>
                                                <option>病假</option>
                                                <option>事假</option>
                                                <option>旅遊假</option>
                                                <option>喪假</option>
                                                <option>生理假</option>
                                                <option>補休(時)</option>
                                                <option>補休(天)</option>
                                                <option>年假</option>
                                            </select>

                                            <input type="date" value={newLeaveForm.startDate} onChange={(e) => setNewLeaveForm({...newLeaveForm, startDate: e.target.value})} className="w-72 max-w-full px-3 py-2 border rounded" required />

                                            <input type="date" value={newLeaveForm.endDate} onChange={(e) => setNewLeaveForm({...newLeaveForm, endDate: e.target.value})} className="w-72 max-w-full px-3 py-2 border rounded" required />

                                            <textarea value={newLeaveForm.reason} onChange={(e) => setNewLeaveForm({...newLeaveForm, reason: e.target.value})} className="w-72 max-w-full px-3 py-2 border rounded" rows="3" required />

                                            <button type="submit" className="w-72 max-w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">
                                                送出申請
                                            </button>
                                        </form>
                                    </div>

                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-lg font-bold mb-4">我的申請</h3>
                                        <div className="space-y-3">
                                            {data.leaves.filter(l => l.userId === currentUser.id).map(leave => (
                                                <div key={leave.id} className="border rounded p-3">
                                                    <div className="flex justify-between mb-2">
                                                        <span className="font-medium">{leave.type}</span>
                                                        <span className={`px-2 py-1 text-xs rounded ${leave.status === '已核准' ? 'bg-green-100' : 'bg-yellow-100'}`}>
                                                            {leave.status}
                                                        </span>
                                                    </div>
                                                     <p className="text-sm md:text-base">{leave.startDate} ~ {leave.endDate}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {currentUser.isAdmin && (
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="text-lg font-bold mb-4">待審核 (管理員)</h3>
                                          <p className="text-xs text-gray-500 mb-3">僅可審核具權限的地區或部門</p>
                                       {approvablePendingLeaves.map(leave => {
                                            return (
                                                <div key={leave.id} className="border rounded p-4 mb-3">
                                                    <div className="flex justify-between">
                                                        <div>
                                                            <p className="font-medium">{leave.userName} - {leave.type}</p>
                                                            <p className="text-sm md:text-base">{leave.startDate} ~ {leave.endDate}</p>
                                                            <p className="text-xs text-gray-500">{leave.region} / {leave.department}</p>
                                                        </div>
                                                        <div className="flex space-x-2">
                                                            <button
                                                               onClick={() => handleApproveLeave(leave.id, '已核准')}
                                                                className="px-3 py-1 rounded text-white bg-green-600"
                                                            >
                                                                核准
                                                            </button>
                                                            <button
                                                               onClick={() => handleApproveLeave(leave.id, '已拒絕')}
                                                                className="px-3 py-1 rounded text-white bg-red-600"
                                                            >
                                                                拒絕
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                             );
                                        })}
                                       {approvablePendingLeaves.length === 0 && (
                                            <p className="text-center text-gray-500 py-4">目前沒有待審核申請</p>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'annual' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">特休總覽</h2>
                                    <div className="flex space-x-2">
                                        <select
                                            value={filterRegion}
                                            onChange={(e) => setFilterRegion(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>全部</option>
                                            <option>新竹區</option>
                                            <option>台中區</option>
                                            <option>嘉義區</option>
                                        </select>
                                        <select
                                            value={filterDepartment}
                                            onChange={(e) => setFilterDepartment(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>全部</option>
                                            <option>管理部</option>
                                            <option>TSE</option>
                                            <option>FAE</option>
                                            <option>新場</option>
                                            <option>倉管</option>
                                            <option>RD</option>
                                            <option>線上客服</option>
                                        </select>
                                         <select
                                            value={filterShift}
                                            onChange={(e) => setFilterShift(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>全部</option>
                                            <option>早</option>
                                            <option>晚</option>
                                        </select>
                                        <button
                                            onClick={() => exportToCSV('annual')}
                                            className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                        >
                                            <Download size={18} />
                                            <span>匯出Excel</span>
                                        </button>
                                    </div>
                                </div>
                                <div className="bg-white rounded-lg shadow overflow-x-auto">
                                    <table className="w-full">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-4 py-3 text-left">員工</th>
                                                <th className="px-4 py-3 text-left">地區</th>
                                                <th className="px-4 py-3 text-left">部門</th>
                                                <th className="px-4 py-3 text-left">班別</th>
                                                <th className="px-4 py-3 text-left">總特休</th>
                                                <th className="px-4 py-3 text-left">已使用</th>
                                                <th className="px-4 py-3 text-left">剩餘</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {data.users.filter(user => isVisibleStaff(user) &&
                                                (filterRegion === '全部' || user.region === filterRegion) &&
                                                (filterDepartment === '全部' || user.department === filterDepartment) &&
                                                (filterShift === '全部' || user.shift.includes(filterShift))
                                            ).map(user => {
                                                const used = data.leaves.filter(l => l.userId === user.id && l.type === '特休' && l.status === '已核准').length;
                                                return (
                                                    <tr key={user.id}>
                                                         <td className="px-4 py-3">
                                                            <button
                                                                type="button"
                                                                onClick={() => setSelectedAnnualUserId(user.id)}
                                                                className="text-blue-600 hover:text-blue-800 hover:underline"
                                                            >
                                                                {user.name}
                                                            </button>
                                                        </td>
                                                        <td className="px-4 py-3">{user.region}</td>
                                                        <td className="px-4 py-3">{user.department}</td>
                                                        <td className="px-4 py-3">{user.shift.join('/')}</td>
                                                        <td className="px-4 py-3">{user.annualLeave} 天</td>
                                                        <td className="px-4 py-3">{used} 天</td>
                                                        <td className="px-4 py-3">
                                                            <span className="px-2 py-1 bg-green-100 rounded">{user.annualLeave - used} 天</span>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>

                                {selectedAnnualUserId && (() => {
                                    const selectedUser = data.users.find(user => user.id === selectedAnnualUserId);
                                    if (!selectedUser) return null;

                                    const approvedAnnualLeaves = data.leaves.filter(
                                        leave => leave.userId === selectedAnnualUserId && leave.type === '特休' && leave.status === '已核准'
                                    );
                                    const uniqueLeaveDates = [
                                        ...new Set(
                                            approvedAnnualLeaves.flatMap(leave => getDateRangeList(leave.startDate, leave.endDate))
                                        )
                                    ].sort();

                                    return (
                                        <div className="bg-white rounded-lg shadow p-6 space-y-3">
                                            <div className="flex items-center justify-between">
                                                <h3 className="text-lg font-bold">{selectedUser.name} 特休明細</h3>
                                                <button
                                                    type="button"
                                                    onClick={() => setSelectedAnnualUserId('')}
                                                    className="text-sm text-gray-500 hover:text-gray-700"
                                                >
                                                    關閉
                                                </button>
                                            </div>
                                            <p className="text-sm text-gray-600">核准特休筆數：{approvedAnnualLeaves.length} 筆</p>

                                            {approvedAnnualLeaves.length === 0 ? (
                                                <p className="text-gray-500">目前尚無已核准的特休紀錄。</p>
                                            ) : (
                                                <>
                                                    <div className="space-y-2">
                                                        {approvedAnnualLeaves.map(leave => (
                                                            <div key={leave.id} className="p-3 border rounded bg-gray-50 text-sm">
                                                                <div>{leave.startDate} ~ {leave.endDate}</div>
                                                                <div className="text-gray-600">事由：{leave.reason || '未填寫'}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <div>
                                                        <p className="text-sm font-medium mb-1">休假日期</p>
                                                        <div className="flex flex-wrap gap-2">
                                                            {uniqueLeaveDates.map(date => (
                                                                <span key={date} className="px-2 py-1 text-xs rounded bg-indigo-100 text-indigo-700">{date}</span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    );
                                })()}
                            </div>
                        )}

                        {/* 補休表 */}
                        {activeTab === 'compensatory' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">補休表</h2>
                                    <div className="flex space-x-2">
                                        <select
                                            value={filterRegion}
                                            onChange={(e) => setFilterRegion(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>全部</option>
                                            <option>新竹區</option>
                                            <option>台中區</option>
                                            <option>嘉義區</option>
                                        </select>
                                        <select
                                            value={filterDepartment}
                                            onChange={(e) => setFilterDepartment(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>全部</option>
                                            <option>管理部</option>
                                            <option>TSE</option>
                                            <option>FAE</option>
                                            <option>新場</option>
                                            <option>倉管</option>
                                            <option>RD</option>
                                            <option>線上客服</option>
                                            </select>
                                        <select
                                            value={filterShift}
                                            onChange={(e) => setFilterShift(e.target.value)}
                                            className="px-4 py-2 border rounded-lg"
                                        >
                                            <option>全部</option>
                                            <option>早</option>
                                            <option>晚</option>
                                        </select>
                                        <button
                                            onClick={() => exportToCSV('compensatory')}
                                            className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                        >
                                            <Download size={18} />
                                            <span>匯出Excel</span>
                                        </button>
                                    </div>
                                </div>

                              <div className="bg-white rounded-lg shadow p-4">
                                    <div className="flex items-center justify-between mb-4">
                                        <button
                                            onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() - 1, 1))}
                                            className="px-3 py-1 border rounded hover:bg-gray-50"
                                        >
                                            上月
                                        </button>
                                        <h3 className="text-lg font-semibold">{selectedMonth.getFullYear()} 年 {selectedMonth.getMonth() + 1} 月補休安排</h3>
                                        <button
                                            onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() + 1, 1))}
                                            className="px-3 py-1 border rounded hover:bg-gray-50"
                                        >
                                            下月
                                        </button>
                                    </div>

                                    <div className="overflow-x-auto">
                                       <table className="w-full text-sm">
                                            <thead>
                                                <tr>
                                                    <th className="sticky left-0 bg-gray-50 px-4 py-2 border">員工</th>
                                                    <th className="px-4 py-2 border">地區</th>
                                                    <th className="px-4 py-2 border">部門</th>
                                                    <th className="px-4 py-2 border">班別</th>
                                                    {monthDays.map(day => {
                                                        const dateStr = formatLocalDate(day);
                                                        const holiday = holidays2026.find(h => h.date === dateStr);
                                                        const isWeekend = day.getDay() === 0 || day.getDay() === 6;
                                                        return (
                                                            <th
                                                                key={dateStr}
                                                                className={`min-w-[52px] px-2 py-2 border text-center ${holiday ? 'bg-red-50 text-red-600' : isWeekend ? 'bg-blue-50 text-blue-600' : 'bg-gray-50'}`}
                                                            >
                                                                {day.getDate()}
                                                            </th>
                                                        );
                                                    })}
                                                    <th className="px-4 py-2 border bg-gray-50">本月補休(時)</th>
                                                    <th className="px-4 py-2 border bg-gray-50">本月補休(天)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {data.users
                                                    .filter(u => isVisibleStaff(u))
                                                    .filter(u =>
                                                        (filterRegion === '全部' || u.region === filterRegion) &&
                                                        (filterDepartment === '全部' || u.department === filterDepartment) &&
                                                        (filterShift === '全部' || u.shift.includes(filterShift))
                                                    )
                                                    .map(user => {
                                                        const currentMonthStats = getCompStats(user.id, selectedMonth);
                                                        return (
                                                            <tr key={user.id} className="hover:bg-gray-50">
                                                                <td className="sticky left-0 bg-white px-4 py-2 border font-medium">{user.name}</td>
                                                                <td className="px-4 py-2 border">{user.region}</td>
                                                                <td className="px-4 py-2 border">{user.department}</td>
                                                                <td className="px-4 py-2 border">{user.shift.join('/')}</td>
                                                                {monthDays.map(day => {
                                                                    const dateStr = formatLocalDate(day);
                                                                    const cell = getCompensatoryCellData(user.id, dateStr);
                                                                    const holiday = holidays2026.find(h => h.date === dateStr);
                                                                    const isWeekend = day.getDay() === 0 || day.getDay() === 6;
                                                                    return (
                                                                        <td
                                                                            key={`${user.id}-${dateStr}`}
                                                                            className={`px-2 py-2 border text-center font-medium ${cell ? 'text-indigo-700 bg-indigo-50' : holiday ? 'bg-red-50' : isWeekend ? 'bg-blue-50' : ''}`}
                                                                        >
                                                                            {cell || '-'}
                                                                        </td>
                                                                    );
                                                                })}
                                                                <td className="px-4 py-2 border text-center">{currentMonthStats.hours} 小時</td>
                                                                <td className="px-4 py-2 border text-center">{currentMonthStats.days} 天</td>
                                                            </tr>
                                                        );
                                                    })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 排程表 */}
                        {activeTab === 'schedule' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-bold">排程表</h2>
                                    <button
                                        onClick={() => exportToCSV('schedule')}
                                        className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        <Download size={18} />
                                        <span>匯出Excel</span>
                                    </button>
                                </div>

                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <button
                                            onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() - 1))}
                                            className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200"
                                        >
                                            上個月
                                        </button>
                                        <h3 className="text-xl font-bold">
                                            {selectedMonth.getFullYear()}年 {selectedMonth.getMonth() + 1}月 排程
                                        </h3>
                                        <button
                                            onClick={() => setSelectedMonth(new Date(selectedMonth.getFullYear(), selectedMonth.getMonth() + 1))}
                                            className="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200"
                                        >
                                            下個月
                                        </button>
                                    </div>

                                    <div className="grid grid-cols-7 gap-2">
                                        {['日', '一', '二', '三', '四', '五', '六'].map(day => (
                                            <div key={day} className="text-center font-bold py-2 bg-gray-50 rounded">
                                                {day}
                                            </div>
                                        ))}
                                        
                                        {monthDays.map(day => {
                                            const holiday = isHoliday(day);
                                            const weekend = isWeekend(day);
                                            const dateStr = formatLocalDate(day);
                                            const schedules = data.schedules?.filter(s => s.date === dateStr) || [];

                                            return (
                                                <div
                                                    key={day.toISOString()}
                                                    className={`min-h-24 p-2 border rounded-lg ${
                                                        holiday ? 'bg-red-50' :
                                                        weekend ? 'bg-blue-50' :
                                                        'bg-white'
                                                    } hover:shadow-md cursor-pointer transition-shadow`}
                                                    onClick={() => toggleScheduleDateExpand(dateStr)}
                                                >
                                                   <div className="font-bold text-sm md:text-base mb-1">
                                                        {day.getDate()}
                                                        {holiday && <span className="ml-1 text-xs text-red-600">{holiday.name}</span>}
                                                    </div>
                                                    <div className="space-y-1">
                                                        {schedules.map(schedule => (
                                                            <div key={schedule.id} className="text-xs bg-indigo-100 text-indigo-800 p-1 rounded">
                                                                <div className="font-medium">{schedule.title}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    
                                     </div>

                                {expandedScheduleDate && (
                                    <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50">
                                        <div className="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6 max-h-[80vh] overflow-y-auto">
                                            <div className="flex items-center justify-between gap-3 mb-3">
                                                <h4 className="text-base md:text-lg font-bold text-indigo-800">
                                                    {expandedScheduleDate} 排程明細
                                                </h4>
                                               <div className="flex items-center gap-2">
                                                    <button
                                                        type="button"
                                                        onClick={() => openScheduleModal(expandedScheduleDate)}
                                                        className="px-3 py-1.5 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm md:text-base"
                                                    >
                                                        新增排程
                                                    </button>
                                                    <button
                                                        type="button"
                                                        onClick={() => setExpandedScheduleDate('')}
                                                        className="text-gray-500 hover:text-gray-700"
                                                        title="關閉"
                                                    >
                                                        ✕
                                                    </button>
                                                </div>
                                            </div>
                                            <div className="space-y-2">
                                                {(data.schedules?.filter(s => s.date === expandedScheduleDate) || []).length > 0 ? (
                                                    (data.schedules?.filter(s => s.date === expandedScheduleDate) || []).map(schedule => (
                                                        <div key={schedule.id} className="bg-white border border-indigo-100 rounded p-3">
                                                            <div className="flex items-start justify-between gap-2">
                                                                <div className="font-medium text-indigo-900">{schedule.title}</div>
                                                                <div className="flex items-center gap-2">
                                                                    <button
                                                                        type="button"
                                                                        onClick={() => handleEditSchedule(schedule)}
                                                                        className="text-indigo-600 hover:text-indigo-800"
                                                                        title="編輯行程"
                                                                    >
                                                                        <Edit2 size={16} />
                                                                    </button>
                                                                    <button
                                                                        type="button"
                                                                        onClick={() => handleDeleteSchedule(schedule.id)}
                                                                        className="text-red-600 hover:text-red-800"
                                                                        title="刪除行程"
                                                                    >
                                                                        <Trash2 size={16} />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div className="mt-1 text-sm md:text-base text-gray-700">{schedule.content}</div>
                                                        </div>
                                                    ))
                                                ) : (
                                                    <p className="text-sm md:text-base text-gray-600">此日期目前沒有排程項目。</p>
                                                )}
                                            </div>
                                        </div>
                                  </div>
                                )}

                                {showScheduleModal && (
                                    <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50">
                                        <div className="bg-white rounded-lg shadow-lg w-full max-w-xl p-6">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-lg font-bold">{editingScheduleId ? '編輯排程' : '新增排程'}（{selectedScheduleDate}）</h3>
                                                <button
                                                    type="button"
                                                    onClick={() => {
                                                        setShowScheduleModal(false);
                                                        setEditingScheduleId(null);
                                                    }}
                                                    className="text-gray-500 hover:text-gray-700"
                                                >
                                                    ✕
                                                </button>
                                            </div>
                                            <form onSubmit={handleScheduleSubmit} className="space-y-3">
                                                <input
                                                    type="text"
                                                    value={scheduleForm.title}
                                                    onChange={(e) => setScheduleForm(prev => ({ ...prev, title: e.target.value }))}
                                                    placeholder="標題"
                                                    className="w-72 max-w-full px-3 py-2 border rounded"
                                                    required
                                                />
                                                <textarea
                                                    value={scheduleForm.content}
                                                    onChange={(e) => setScheduleForm(prev => ({ ...prev, content: e.target.value }))}
                                                    placeholder="內容"
                                                    className="w-72 max-w-full px-3 py-2 border rounded"
                                                    rows="4"
                                                    required
                                                />
                                                <div className="flex justify-end gap-2 pt-2">
                                                    <button
                                                        type="button"
                                                        onClick={() => {
                                                            setShowScheduleModal(false);
                                                            setEditingScheduleId(null);
                                                        }}
                                                        className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
                                                    >
                                                        取消
                                                    </button>
                                                    <button
                                                        type="submit"
                                                        className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700"
                                                    >
                                                        儲存
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EmployeeLeaveSystem />);
    </script>
</body>
</html>
